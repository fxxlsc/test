/*! 
* WeX5 v3 (http://www.justep.com) 
* Copyright 2015 Justep, Inc.
* Licensed under Apache License, Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0) 
*/

/* Copyright (c) 2010-2016 Marcus Westin */

/*! 
 * WeX5 v3 (http://www.justep.com) 
 * Copyright 2015 Justep, Inc.
 * Licensed under Apache License, Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0) 
 */

define("$model/UI2/system/lib/base/viewComponent",["require","$UI/system/resources/system.res","./component","./util","./object","./message","./error","jquery","bind"],function(require){require("$UI/system/resources/system.res");var Component=require("./component"),Util=require("./util"),Object=require("./object"),Message=require("./message"),_Error=require("./error"),$=require("jquery"),bind=require("bind"),BIND_PREFIX="bind-",BIND_ATTR_PREFIX="bind-attr-",EVENT_NAME="data-events",BIND_NAME="data-bind",BIND_EVENTS=["bind-click","bind-dbclick","bind-dblclick","bind-focus","bind-blur","bind-select","bind-mousedown","bind-mouseup","bind-mouseover","bind-mousemove","bind-mouseout","bind-mouseenter","bind-mouseleave","bind-keydown","bind-keyup","bind-keypress","bind-touchstart","bind-touchmove","bind-touchend","bind-abort","bind-error","bind-change","bind-reset","bind-resize","bind-submit","bind-load","bind-unload","bind-keynavigatedfocus","bind-keynavigateblur"],ViewComponent=Component.extend({constructor:function(e){this.__eventOperation__={},this.__events={},this.callParent(e)},getXid:function(){return this.domNode?this.domNode.getAttribute("xid"):null},constructed:function(e){this.callParent();if(e&&e.templateNode)this._bind(e.templateNode);else{e=e||{};var t=this.buildTemplate(e);if(!!t){var n=$(t)[0];this._bind(n),this._processEvents(e),this._processComponentBind(e),this._processBind(n,e),e.parentNode&&Component.addComponent(e.parentNode,this)}}},getDataByExpr:function(expr){var $$__data__$$=this.getModel().comp(expr);if($$__data__$$)return $$__data__$$;try{var ctx=bind.contextFor(this.domNode);with(this.getModel())with(ctx)$$__data__$$=eval("("+expr+")");return $$__data__$$}catch(e){return null}},_getComponentBinds:function(){var e=this.getConfig()||{};return e.binds||{}},_processComponentBind:function(e){e=e||{};var t=$(this.domNode),n=t.attr(Component.COMPONENT_ATTR_NAME);if(n){var r="component:{name:'"+n+"'",i=this._getComponentBinds();for(var s in i)i.hasOwnProperty(s)&&e[s]&&(r&&(r+=","),r+=i[s]+":"+e[s]);r+="}";var o=t.attr(BIND_NAME);o&&(r=o+","+r),t.attr(BIND_NAME,r)}},_getEvents:function(){var e=this.getConfig()||{};return e.events||[]},_processEvents:function(e){if(!e)return;var t=this._getEvents();if(Util.isArray(t))for(var n=0;n<t.length;n++)e[t[n]]&&(this.__events[t[n]]=e[t[n]])},_getStandardBinds:function(e,t){var n={},r=$(e),i=e.attributes;for(var s=0;s<i.length;s++){var o=i[s].name,u=i[s].value;o.indexOf(BIND_PREFIX)===0&&(n[o]=u,r.removeAttr())}t=t||{};var a=(this.getConfig()||{}).binds||{};for(var f in t)t.hasOwnProperty(f)&&f.indexOf(BIND_PREFIX)===0&&!(f in a)&&(n[f]=t[f]);return n},_processEventValue:function(e){return e&&e.indexOf(".")==-1&&e.indexOf("(")==-1?"$model._callModelFn.bind($model, '"+e+"')":e&&e.indexOf("{")===0?"$model._callModelFn.bind($model, "+e+")":e},_processBind:function(e,t){if(e.nodeType!=1)return;var n=$(e),r="",i="",s="",o="",u=this._getStandardBinds(e,t);for(var a in u)if(u.hasOwnProperty(a)){var f=u[a];BIND_EVENTS.indexOf(a)!=-1?(r=a.substring(BIND_PREFIX.length),o&&(o+=","),o+=r+":"+this._processEventValue(f)):a.indexOf(BIND_ATTR_PREFIX)===0?(r=a.substring(BIND_ATTR_PREFIX.length),s&&(s+=","),s+=r+":"+f):(r=a.substring(BIND_PREFIX.length),i&&(i+=","),i+=r+":"+f)}s&&(i&&(i+=","),i+="attr:{"+s+"}"),o&&(i&&(i+=","),i+="event:{"+o+"}");if(i){var l=n.attr(BIND_NAME);l&&(i=l+","+i),n.attr(BIND_NAME,i)}var c=n.children();for(var h=0;h<c.length;h++)this._processBind(c[h])},setCSS:function(e){this.$domNode.css(e)},addClass:function(e){this.$domNode.addClass(e)},toggleClass:function(e){this.$domNode.toggleClass(e)},removeClass:function(e){this.$domNode.removeClass(e)},fireEvent:function(e,t){return t&&this.domNode&&!t.hasOwnProperty("bindingContext")&&(t.bindingContext=bind.contextFor(this.domNode)),this.callParent(e,t)},free:function(){this.domNode&&bind.removeNode(this.domNode)},dispose:function(){this.domNode&&(this.getModel()&&this.getModel()._disposeComponent(this.domNode),bind.utils.domData.set(this.domNode,Component.BIND_NAME,null),this.domNode=null,this.$domNode=null),this.callParent()},inited:function(){this.getModel().resolvedComponent(this.domNode)},buildTemplate:function(e){},init:function(e,t){var n=this.$domNode.data("config");n&&this.set(n);var r=this.getModel(),i=$(this.domNode).attr(EVENT_NAME);if(typeof i=="string"){var s=i.split(";");for(var o=0;o<s.length;o++){var u=s[o];if(u!==""){var a=u.indexOf(":");if(a==-1){var c=new Message(Message.JUSTEP230065,i);throw _Error.create(c)}var f=u.substring(0,a),l=u.substring(a+1);this.on(f,l,r)}}}for(var h in this.__events)this.__events.hasOwnProperty(h)&&this.on(h,this.__events[h],r);delete this.__events},update:function(e,t){if(!e)return;var n={},r=null;for(r in e)e.hasOwnProperty(r)&&(n[r]=bind.utils.unwrapObservable(e[r]));if(!this._oldValues){this._oldValues=n;return}for(r in n)if(n.hasOwnProperty(r)){var i=this._oldValues[r],s=n[r];if(s!==i){var o={name:r,value:s,oldValue:i,allValue:n,oldAllValue:this._oldValues,source:this};this.fireEvent(ViewComponent.DATA_CHANGED,o),this._oldValues[r]=s}}this._oldValues=n},controlsDescendantBindings:function(){return!1},getComponentByCompID:function(e){var t=this.getElementByCompID(e);return Component.getComponent(t)},getElementByCompID:function(e){return this._getElementByCompID(this.domNode,e)},_getElementByCompID:function(e,t){var n=$(e);if(e!==this.domNode&&n.attr(Component.COMP_ID)===t)return e;if(!n.attr(Component.COMPONENT_ATTR_NAME)){var r=n.children();for(var i=0;i<r.length;i++){var s=r[i],o=this._getElementByCompID(s,t);if(o)return o}}return null},hasDisplayFunc:function(){return"function"==typeof this.getDisplayHtml||"function"==typeof this.getDisplayText},_bind:function(e){bind.utils.domData.set(e,Component.BIND_NAME,this),this.domNode=e,this.$domNode=$(this.domNode),bind.utils.domNodeDisposal.addDisposeCallback(e,this.dispose.bind(this))}}),DisplayContext=Object.extend({constructor:function(e){this.comp=e.comp,this.type=e.type,this.colDef=e.colDef,this.row=e.row,this.extendType=e.extendType,this.editor=e.editor,this.readonly=e.readonly,this.bindRef=e.bindRef},getParam:function(e){if(this.editor)return this.editor.get(e);if(this.extendType)return this.extendType.getParam(e)}});return ViewComponent.defaultCreateEditor=function(e,t){if(!t)return;var n={};return $.extend(n,t.getParam()),t.bindRef&&(n["bind-ref"]=t.bindRef),new e(n)},ViewComponent.DisplayContext=DisplayContext,ViewComponent.CreateEditorContext=DisplayContext,ViewComponent.DATA_CHANGED="onDataChanged",ViewComponent}),define("$model/UI2/system/lib/base/modelComponent",["require","./component"],function(e){var t=e("./component"),n=t.extend({getXid:function(){return this.xid}});return n}),define("$model/UI2/system/lib/base/bindComponent",["require","bind","./viewComponent","./object"],function(e){var t=e("bind"),n=e("./viewComponent"),r=e("./object"),i=n.extend({constructor:function(e){this.disabled=!1,this.refDisabled=!1,this.callParent(e)},doInit:function(e,t,n){},render:function(){this.needRender=!1},isDisabled:function(){return this.disabled||this.refDisabled},dispose:function(){this._subscribeReadOnlyHandle&&this._subscribeReadOnlyHandle.dispose(),this._subscribeValidationHandle&&this._subscribeValidationHandle.dispose(),this.callParent()},val2ref:function(){if(t.isObservable(this.ref)){var e="function"!=typeof this.val?this.get("value"):this.val();this._val2ref(this.ref,e)}},_val2ref:function(e,n){t.isObservable(e)&&e.set(n)},init:function(e,t,n){this.callParent(e,t,n);if(this.hasOwnProperty("value")&&n&&n.has("value")){var r=n.get("value");this.value=r;var s=this;this.$domNode.on("koUpdateValue",function(){s.value=s.$domNode.val()})}var o=this.ref;e&&e.ref instanceof i.NullValue&&this.set({refDisabled:!0}),this.ref=!e||e.ref instanceof i.NullValue?null:e.ref;var u=this.doInit(e,t,n);return this.doUpdate(e,t,n),o!==this.ref&&(this._subscribeReadOnly(this.ref),this._subscribeValidation(this.ref)),this._inited=!0,this.render(),u},update:function(e,t,n){var r=this.ref;e&&e.ref instanceof i.NullValue&&this.set({refDisabled:!0}),this.ref=!e||e.ref instanceof i.NullValue?null:e.ref,this.doUpdate(e,t,n),r!==this.ref&&(this._subscribeReadOnly(this.ref),this._subscribeValidation(this.ref)),this.callParent(e,t,n)},doUpdate:function(e,t,n){e&&e.hasOwnProperty("ref")&&(this.updateValue(e.ref),this.updateReadonly(e.ref),this.updateValidation(e.ref))},_subscribeReadOnly:function(e){this._subscribeReadOnlyHandle&&this._subscribeReadOnlyHandle.dispose();if(t.isObservable(e)&&e.readonly&&t.isObservable(e.readonly.computed)){var n=this;this._subscribeReadOnlyHandle=e.readonly.computed.subscribe(function(){n.updateReadonly(e)})}},_subscribeValidation:function(e){this._subscribeValidationHandle&&this._subscribeValidationHandle.dispose();if(t.isObservable(e)&&t.isObservable(e.isValid)){var n=this;this._subscribeValidationHandle=e.isValid.subscribe(function(){n.updateValidation(e)})}},updateValue:function(e){var n=t.isObservable(e)?e.get():e instanceof i.NullValue?"":e;"function"!=typeof this.val?this.set({value:n}):this.val(n)},updateValidation:function(e){if(!t.isObservable(e)||!e.isValid||!e.isModified)return;var n=e.isModified.get(),r=e.isValid.get(),i=(n?!r:!1)?"addClass":"removeClass";this.$domNode[i]("has-error");var s=this.$domNode.attr("data-orig-title");null===s&&(s=this.$domNode.attr("title")),this.$domNode.attr("title",r?s:e.error.get()).attr("data-orig-title",r?null:s)},updateReadonly:function(e){if(t.isObservable(e)&&e.readonly&&"function"==typeof e.readonly.readonlyFN){e.readonly.used||(e.readonly.computed=t.computed(function(){var t=e.readonly.readonlyFN;return t.call(e.readonly.ctx.caller,e.readonly.readonlyDef,e.readonly.ctx)}),e.readonly.used=!0);var n=e.readonly.computed.get();this.set({refDisabled:n})}},disabledRender:function(){this.$domNode&&this.$domNode.attr("disabled",this.isDisabled())},propertyChangedHandler:function(e,t,n){this.$domNode&&(e==="disabled"||e==="refDisabled"?this.disabledRender():this.$domNode.attr(e,n))},set:function(e,t){e&&(this.callParent(e,t),this.needRender&&this.render())}});return i.NullValue=r.extend({toString:function(){return""}}),i}),define("$model/UI2/system/components/justep/data/js/rules",["require","$UI/system/lib/justep","$UI/system/lib/base/express","$UI/system/lib/bind/bind.validation"],function(e){function s(e,t,r){return r.$val=e,"string"==typeof t.expr&&(t.expr=new n(t.expr)),t.expr instanceof n?n.eval(t.expr,r.$row,r):!0}function o(e){return e.$data.label(e.$col)}function u(e,t,n){return r.utils.isEmptyVal(e)||t.test(e.toString())}var t=e("$UI/system/lib/justep"),n=e("$UI/system/lib/base/express");e("$UI/system/lib/bind/bind.validation");var r=t.Bind.validation,i={add:function(e,t){r.rules[e]=t,r.registerExtenders()},remove:function(e){delete r.rules[e]},isExist:function(e){return!!r.rules[e]},each:function(e){if("function"==typeof e){var t=r.rules;for(var n in t)e(n,t[n])}}};return r.rules.constraint={validator:s,message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231600,r,e.expr.expr)).getMessage()}},r.rules.required={validator:function(e,t,n){var r=/^\s+|\s+$/g,i,o=t.expr?s(e,t,n):t;return o?e===undefined||e===null?!o:(i=e,typeof e=="string"&&(i=e.replace(r,"")),(i+"").length>0):!o},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231601,r)).getMessage()}},r.rules.pattern={validator:u,message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231602,r,e)).getMessage()}},r.rules.email={validator:function(e,t,n){return t?r.utils.isEmptyVal(e)||t&&/\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/.test(e):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231603,r)).getMessage()}},r.rules.datetime={validator:function(e,t,n){return t?u(e,/^([0-9][0-9]{3})-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])T([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9](\.[0-9]+)?(Z|[+-]([01][0-9]|2[0-3]):[0-5][0-9])?$/,n):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231604,r)).getMessage()}},r.rules.date={validator:function(e,t,n){return t?u(e,/^([0-9][0-9]{3})-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])(Z|[+-]([01][0-9]|2[0-3]):[0-5][0-9])?$/,n):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231605,r)).getMessage()}},r.rules.time={validator:function(e,t,n){return t?u(e,/^([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9](\.[0-9]+)?(Z|[+-]([01][0-9]|2[0-3]):[0-5][0-9])?$/,n):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231606,r)).getMessage()}},r.rules.number={validator:function(e,t,n){return t?r.utils.isEmptyVal(e)||t&&/^(([-+]?([0-9]+(\.[0-9]*)?)|(\.[0-9]+))([eE][-+]?[0-9]+)?|-?INF|NaN)$/.test(e):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231607,r)).getMessage()}},r.rules.integer={validator:function(e,t,n){return t?r.utils.isEmptyVal(e)||t&&/^-?[0-9]\d*$/.test(e):!0},message:function(e,n){var r=o(n);return(new t.Message(t.Message.JUSTEP231608,r)).getMessage()}},r.registerExtenders(),i}),define("$model/UI2/system/components/justep/data/js/extendType",["require","$UI/system/lib/justep","jquery"],function(e){var t=e("$UI/system/lib/justep"),n=e("jquery"),r=t.Object.extend({constructor:function(e,t,n){this.callParent(),this.data=e,this.col=t,this._def=n},getParam:function(e){this._param||("string"==typeof this._def.param?this._param=n.parseJSON(this._def.param):this._def.param&&(this._param=this._def.param));if(this._param)return e?this._param[e]:this._param},getModel:function(){return this.data.getModel()},getEditor:function(){var e=this._def.editor;if(e)return e;var t=u(this.getModel(),this._def.name);if(t)return t.editor}}),i="__ExtendTypes__",s=function(e){return this[i]};r.registerExtendType=function(e,n){if(!(e instanceof t.ModelBase)){var r=new t.Message(t.Message.JUSTEP231102,n.name);throw t.Error.create(r)}typeof e.getExtendTypes!="function"&&(e.getExtendTypes=s),e[i]||(e[i]={}),e[i][n.name]=n},r.unregisterExtendType=function(e,t){if(e[i]){var n=e[i];n[t]&&delete n[t]}},r.getEditor=function(e,t){var n=r.getExtendTypeObject(e,t);if(n)return n.getEditor()};var o=function(e){if(e&&e.define){var t=e.define;return t.defCol?t.defCol.extendType:null}},u=function(e,t){return e[i][t]};r.getExtendTypeDef=function(e,t){if(e&&e[i]&&t&&t.define){var n=o(t);if(n)return u(e,n.name)}};var a=function(e,t){var n=u(e,t);if(n)return n["class"]};return r.getExtendTypeClass=function(e,t){var n=r.getExtendTypeDef(e,t);if(n)return n["class"]},r.getExtendTypeObject=function(e,t){if(e&&e[i]&&t&&t.define){var n=o(t);if(n){if(n.object)return n.object;var r=a(e,n.name);if(r){var s=t.define;return n.object=new r(s.data,s.col,n),n.object}}}},r.getExtendTypeObjectByColDef=function(e,t){if(e&&t){var n=e.getModel(),r=t.extendType;if(n&&n[i]&&r){if(r.object)return r.object;var s=a(n,r.name);if(s)return r.object=new s(e,t.name,r),r.object}}},r}),define("$model/UI2/system/components/justep/data/data",["require","jquery","$UI/system/lib/justep","./js/rules","./js/extendType","$UI/system/lib/base/shareData","$UI/system/lib/bind/bind.validation","$UI/system/resources/system.res"],function(require){var $=require("jquery"),justep=require("$UI/system/lib/justep"),Bind=justep.Bind,Model=justep.ModelBase,Expr=justep.Express,Rules=require("./js/rules"),ExtendType=require("./js/extendType"),ShareData=require("$UI/system/lib/base/shareData");require("$UI/system/lib/bind/bind.validation"),require("$UI/system/resources/system.res");var Row=justep.Object.extend({constructor:function(e,t){this.data=e,this.row=t},ref:function(e){var t=this.row[e];return t?t.value:undefined},getValue:function(e){return this.data.getValue(e,this)},setValue:function(e,t){this.data.setValue(e,t,this)},val:function(e,t){if(arguments.length==1)return this.data.getValue(e,this);this.data.setValue(e,t,this)},oval:function(e){return this.data.getOriginalValue(e,this)},label:function(e){return this.data.label(e)},parent:function(){return this.row.userdata?this.row.userdata.parent:undefined},index:function(){return this.data.getRowIndex(this)},hasChildren:function(){return this.rows&&this.rows.get().length>0},getChildren:function(){return this.children()},children:function(){return this.rows?this.rows.get():undefined},getID:function(){return this.data.getRowID(this)},assign:function(e,t){if(e instanceof Row){var n,r;if($.isArray(t))for(var i=0;i<t.length;i++)n=t[i],r=e.ref(n),Bind.isObservable(r)&&this.val(n,r.peek());else for(n in this.data.defCols)r=e.ref(n),Bind.isObservable(r)&&this.val(n,r.peek())}},cancelUpdates:function(e){var t=this.data;t.disableRecordChange();try{var n=this.row,r=!1,i=n.userdata.recordState;if(Data.STATE.EDIT==i){r=!0;for(var s in t.defCols){var o=t.defCols[s];!t.isUICalculateCol(s)&&!(o.calculate instanceof Expr)&&n[s].changed&&(n[s].changed=0,n[s].value.set(n[s].originalValue))}}else Data.STATE.NEW==i&&(r=!0,t.remove(n));if(r){n.userdata.recordState=Data.STATE.NONE;if(!e){var u={};u.source=t,u.changedSource=t,u.type="cancel",u.selfChanged=!0,t.doDataChanged(u)}}}finally{t.enabledRecordChange()}},toJson:function(e){return e=e||{},this.data._row2Json(this,e.excludeCalculateCol,e.excludeCols,e.format==="simple")}}),date2Val=function(e){return e instanceof Date?justep.Date.toString(e,justep.Date.STANDART_FORMAT_SHOT):e},time2Val=function(e){return e instanceof Date?justep.Date.toString(e,justep.Date.STANDART_TIME_FORMAT):e},dateTime2Val=function(e){return e instanceof Date?justep.Date.toString(e,justep.Date.STANDART_FORMAT):e},Data=justep.ModelComponent.extend({constructor:function(e,t){this.callParent(),this.clz=Data,this.autoLoad=!1,this.autoNew=!1,this.isMain=!1,this.delim=",",this.versionRelation="version",this.updateMode="whereVersion",this.distinct=null,this.defTreeOption={isTree:!1},this.orderBys=[],this.depends=[],this.userdata={},this.share={},this.directDeleteMode=!1,this.confirmDelete=!0,this.confirmDeleteText=justep.Message.getMessage(justep.Message.JUSTEP231000),this.confirmRefresh=!0,this.confirmRefreshText=justep.Message.getMessage(justep.Message.JUSTEP231001),this.offset=0,this.limit=20,this.dataType="json",this.xid=t?t.xid:"",this.currentRow=Bind.observable(),this.datas=this.allDatas=Bind.observableArray(),this.allDatas.owner=this,this.setTotal(0),this.deleteDatas=Bind.observableArray(),this.slaveDatas=[],this.isModified=Bind.observable(!1),this._isModelConctructed=Bind.observable(!1),this.clientFilter="",this._clientFilterExpr=Bind.observable(),this.isChanged=function(){return this.isSelfChanged()||this.isSlaveChanged()},this._init(e,t)},_getShareData:function(){if(this.share&&this.share.name){var e=ShareData.getShareData(this.share.name);if(!e){var t=this.getModel().getConfig(),n=t&&t.shareDatas&&t.shareDatas[this.share.name];n&&(e=new ShareData(n))}return e}},_loadShareData:function(){var e=this._getShareData();if(e instanceof ShareData&&e.hasData(this.share.flag)){var t=e.get()||[];return this._loadData(t),t.currentID&&this.to(t.currentID),this.fireEvent(Data.EVENT_LOAD_SHARE_DATA,{source:this}),this.share.flag=e.flag(),this.opened=!0,!0}return!1},_updateShareData:function(e){var t=this._getShareData();if(t instanceof ShareData){this._updateShareDataHandle&&clearTimeout(this._updateShareDataHandle);var n=justep.Util.bindModelFn(this.getModel(),function(){this._updateShareDataHandle=null;var e=this._getShareData();if(e instanceof ShareData){var t=this.toJson({excludeCalculateCol:!0}),n=this.getCurrentRow(!0);n&&(t.currentID=n.getID()),e.set(t),this.share.flag=e.flag()}},this);e?n():this._updateShareDataHandle=setTimeout(n,50)}},_updateShareDataCurrentIndex:function(){var e=this._getShareData();if(e instanceof ShareData){var t=e.get();if(t){var n=this.getCurrentRow(!0),r=n.getID();r!=t.currentID&&(t.currentID=r)}}},_getSelfValid:function(e){var t=!0;return this.eachAllByPeek(function(n){var r=n.row,i=r.row.userdata.recordState;e&&r.row.userdata.isModified.set(!0);if(e||Data.STATE.NEW==i||Data.STATE.EDIT==i)for(var s in n.data.defCols){var o=r.ref(s);if(o&&Bind.isObservable(o.isValid)&&!o.isValid.get()){t=!1,n.cancel=!0;break}}},this),t},_getSelfInvalidInfo:function(e){var t=[];return this.eachAllByPeek(function(n){var r=n.row,i=r.row.userdata.recordState;e&&r.row.userdata.isModified.set(!0);if(e||Data.STATE.NEW==i||Data.STATE.EDIT==i)for(var s in n.data.defCols){var o=r.ref(s);if(o&&Bind.isObservable(o.error)){var u=o.error.get();u&&t.push(u)}}},this),t.join(";")},getReadonly:function(e,t){if(e&&t){var n=t.ref(e);return n&&n.readonly&&n.readonly.used?n.readonly.computed.get():this.readonly.get()}return this.readonly.get()},setClientFilter:function(e){this.clientFilter=e;var t=null;e&&"string"==typeof e&&(t=new Expr(e)),this._clientFilterExpr.set(t)},clone:function(e){var t=$.extend({},this.definition);return t.xid=e||Data.UUID(),delete t.master,delete t.autoLoad,delete t.autoNew,new this.clz(this.getModel(),t)},_dispose:function(e){if(Bind.isObservable(e))e.extend({validatable:!1,readonly:!1}),e.getSubscriptionsCount()>0&&(e._subscriptions.change=[]);else if(Bind.isComputed(e))e.extend({validatable:!1,readonly:!1}),e.target&&(this._dispose(e.target),delete e.target),e.dispose();else if(Bind.validation.utils.isObservableArray(e)){var t=e.get(),n=0;for(;n<t.length;n++){var r=t[n].row;r.userdata&&r.userdata.isModified&&this._dispose(r.userdata.isModified);for(var i in this.defCols)this._dispose(r.ref(i))}e.destroyAll()}},dispose:function(){Data.unRegisterData(this.getModel(),this.xid),this._dispose(this.readonly),this._dispose(this.index),this._dispose(this.indexParent),this._dispose(this.currentRow),this._dispose(this.isModified),this._dispose(this._clientFilterExpr),this._dispose(this.allDatas),this._dispose(this.deleteDatas),delete this.readonly,delete this.index,delete this.indexParent,delete this.currentRow,delete this.isModified,delete this._clientFilterExpr,delete this.allDatas,delete this.deleteDatas},cancelUpdates:function(){var e=this.isSelfChanged();this.eachAllByPeek(function(e){e.row.cancelUpdates(!0)},this);var t=this.slaveDatas.length;for(var n=0;n<t;n++)this.slaveDatas[n].cancelUpdates();if(e){var r={};r.source=this,r.changedSource=this,r.type="cancel",r.selfChanged=!0,this.doDataChanged(r)}},createErrorValue:function(e){return Data.createErrorValue(e)},getContext:function(){return this.getModel().getContext()},label:function(e){var t=this.defCols[e];return t?t.label!==undefined&&t.label!==null?t.label:e:""},col:function(e){return e||""},_setLoaded:function(e,t){t?(t.row.userdata||(t.row.userdate={}),t.row.userdata._loaded=e):this.loaded=e},open:function(){var e=$.Deferred();return this.isLoaded()?e.resolve():this.refreshData({onSuccess:function(){e.resolve()},onError:function(){e.reject()}}),e.promise()},isLoaded:function(e){return!e||this.defTreeOption.isTree&&!this.defTreeOption.option.isDelayLoad?this.loaded:e.row.userdata&&e.row.userdata._loaded?e.row.userdata._loaded:!1},hasMore:function(e){if(this.limit==-1)return!1;var t=e?e.rows?e.rows.get():[]:this.datas.get();return this.getTotal(e)>t.length},getTotal:function(e){return this.limit!==-1?e?e.row.userdata&&e.row.userdata._total?e.row.userdata._total.get():0:this.total.get():this.getCount(e)},setTotal:function(e,t){t?(t.row.userdata||(t.row.userdata={}),t.row.userdata._total||(t.row.userdata._total=Bind.observable()),t.row.userdata._total.set(e)):(this.total||(this.total=Bind.observable()),this.total.set(e))},getOffset:function(e){return e?e.row.userdata&&e.row.userdata._offset?e.row.userdata._offset:0:this.offset},setOffset:function(e,t){t?(t.row.userdata||(t.row.userdata={}),t.row.userdata._offset=e):this.offset=e},ref:function(e,t){return this._inited?(typeof t!="object"&&(t=this.getCurrentRow()),t?t.ref(e):new Data.NullValue):new Data.NullValue},val:function(e,t){return this.getValue(e,t)},_eachAll:function(e,t,n,r){if("function"!=typeof e)return;var i=r?"peek":"get",s=n?Bind.isObservable(n.rows)?n.rows[i]():[]:this.allDatas[i](),o=s.length;for(var u=0;u<o;u++){var a={index:u,row:s[u],cancel:!1,parent:n,data:this};e.call(t||a.row,a);if(a.cancel)return;if(Bind.isObservable(a.row.rows)&&!this._eachAll(e,t,a.row,r))return}return!0},_each:function(e,t,n,r){this._eachAll(e,t,n?n:{rows:this.datas},r)},eachAllByPeek:function(e,t,n){return this._eachAll(e,t,n,!0)},eachByPeek:function(e,t,n){this._each(e,t,n,!0)},eachAll:function(e,t,n){return this._eachAll(e,t,n)},each:function(e,t,n){this._each(e,t,n)},getChildren:function(e){return e?Bind.isObservable(e.rows)?e.rows.get():[]:this.datas.get()},isSelfChanged:function(){var e=!1;return this.eachAllByPeek(function(t){var n=t.row.row.userdata.recordState;if(Data.STATE.NEW==n||Data.STATE.EDIT==n)e=!0,t.cancel=!0}),e||this.deleteDatas.peek().length>0},isSlaveChanged:function(){var e=this.slaveDatas.length;for(var t=0;t<e;t++)if(this.slaveDatas[t].isChanged())return!0;return!1},_bindClientFilter:function(){(!this.master||!this.master.xid)&&this.clientFilter&&(this.datas=this._filterBy())},_bindMaster:function(){this.master&&!this.master.masterData&&this.master.xid&&(this.master.masterData=Data.$(this.getModel(),this.master.xid),this.master.masterData&&(this.master.masterData.slaveDatas.push(this),this.byMaster={},this.datas=this._filterBy(),this.setTotal(0),this.datas.subscribe(function(e){var t={};t.source=this,this.fireEvent(Data.EVENT_SLAVEDATAS_CHANGED,t),t.changedSource=this,t.type="slaveDataChanged",t.selfChanged=!0,this.doDataChanged(t)},this),this.master.masterData.currentRow.subscribe(function(e){if(undefined===e)return;var t=this.master.masterData.getRowID(e);this.byMaster[t]||(this.byMaster[t]={}),this.byMaster[t].current=this.getCurrentRow(!0),this.byMaster[t].offset=this.getOffset(),this.byMaster[t].total=this.getTotal()},this,"beforeChange")))},_clientFilter:function(e){var t=[],n=this._clientFilterExpr.get();if(n instanceof Expr)for(var r=0;r<e.length;r++){var i=e[r],s={$model:this.getModel(),$data:this,$row:i};Expr.eval(n,i,s)&&t.push(i)}else t=e;return t},_createReadonly:function(){typeof this.definition.readonly=="string"&&(this.definition.readonly=new Expr(this.definition.readonly));var e=this.getContext();this.readonly=Bind.computed(function(){var t={$model:this.getModel(),$data:this},n=this._isModelConctructed.get();return n?e&&"function"==typeof e.isReadonlyMode&&e.isReadonlyMode()||(this.definition.readonly instanceof Expr?Expr.eval(this.definition.readonly,this,t):this.definition.readonly):!1},this)},getInitDataPromise:function(){return this._InitDataPromise.promise()},_initData:function(){var e=this;this.autoNew?(this._loadShareData(),this.newData({onSuccess:function(){e._InitDataPromise.resolve()},onError:function(){e._InitDataPromise.reject()}})):this.autoLoad&&(this._loadShareData()?e._InitDataPromise.resolve():this.open().then(function(){e._InitDataPromise.resolve()},function(){e._InitDataPromise.reject()}))},_init:function(e,t){if(!e||!t)return;this.setModel(e),this._InitDataPromise=$.Deferred(),this.definition=t,this._createReadonly(e),this._initDefinition(e),this.attachEvents(t.events);var n=function(){this._bindMaster(),Data.registerData(e,this.xid,this);var t={source:this};this.fireEvent(Data.EVENT_CREATE,t),this.getModel().resolvedComponent(this.xid),this._inited=!0},r=this,i=function(e){r._isModelConctructed.set(!0),r._initExtendType();if(!r.master)if(!$.isArray(r.depends)||r.depends.length<=0)r._initData();else{var t=[];for(var n=0;n<r.depends.length;n++){var i=r.depends[n];if(r.xid!==i){var s=r.getModel().comp(i);s instanceof Data?t.push(s.getInitDataPromise()):t.push(r.getModel().componentPromise(i))}}t.length>0?$.when.apply($,t).then(function(){r._initData()},function(e){throw new Error("data[id="+r.id+"]初始化失败，"+e)}):r._initData()}};e.isConstructed()?i():e.on(Model.MODEL_CONSTRUCTING_EVENT,i),this._bindClientFilter(),!this.master||this.master.masterData||!this.master.xid?n.call(r):e.componentPromise(this.master.xid).then(function(){n.call(r)},function(e){var t=new justep.Message(justep.Message.JUSTEP231078,r.xid,e);throw justep.Error.create(t)}),e.on(Model.ACTIVE_EVENT,function(){r.opened&&r._loadShareData()}),e.on(Model.INACTIVE_EVENT,function(){r.opened&&r._updateShareData(!0)})},_initDefinition:function(){this.dataModel=this.definition.dataModel||"",this.definition.autoLoad&&(this.autoLoad=!0),this.definition.autoNew&&(this.autoNew=!0),this.definition.isMain&&(this.isMain=!0),this.definition.depends&&(this.depends=this.definition.depends),this.definition.limit&&(this.limit=this.definition.limit),this.definition.offset&&this.setOffset(this.definition.offset),this.definition.directDelete&&(this.directDeleteMode=this.definition.directDelete),this.definition.confirmDelete===!1&&(this.confirmDelete=!1),this.definition.confirmDeleteText&&(this.confirmDeleteText=this.definition.confirmDeleteText),this.definition.confirmRefresh===!1&&(this.confirmRefresh=!1),this.definition.confirmRefreshText&&(this.confirmRefreshText=this.definition.confirmRefreshText),this.definition.filterRelations&&(this.defFilterRelations=this.definition.filterRelations),this.definition.share&&(this.share.name=this.definition.share),this.definition.updateMode&&(this.updateMode=this.definition.updateMode),this.definition.orderBys&&(this.orderBys=this.definition.orderBys),this.definition.clientFilter&&this.setClientFilter(this.definition.clientFilter);var e=this.definition.filters;for(var t in e)this.setFilter(t,e[t]);this.concept=this.definition.concept,this.idColumn=this.definition.idColumn,this._initDefCols(),this._initRules(),this.defAggCols=this.definition.defAggCols,this.master=this.definition.master,this.definition.treeOption?(this.defTreeOption.isTree=!0,this.defTreeOption.option=this.definition.treeOption):this.defTreeOption.option={}},getTreeOption:function(){return this.defTreeOption.option},_initExtendType:function(){for(var e in this.defCols)ExtendType.getExtendTypeObjectByColDef(this,this.defCols[e])},_initDefCols:function(){this.defCols=this.definition.defCols},_initRules:function(){for(var e in this.defCols){var t=this.defCols[e].rules;if(t&&!Bind.validation.utils.isObservableArray(t)){var n=[];for(var r in t){if("readonly"==r||"calculate"==r||"defaultValue"==r){this.defCols[e][r]=t[r],delete t[r];continue}var i=t[r];i&&(i.message||i.onlyIf)?n.push({rule:r,message:i.message,params:Bind.validation.utils.isEmptyVal(i.params)?!0:i.params,condition:i.onlyIf}):n.push({rule:r,params:i.params?i.params:i})}n.length>0?this.defCols[e].rules=Bind.observableArray(n):delete this.defCols[e].rules}}},addRule:function(e,t){var n=this.defCols[e];n&&(n.rules?n.rules.push(t):n.rules=Bind.observableArray([t]))},buildFilter:function(){return""},getFilter:function(e){return""},setFilter:function(e,t){return""},setOrderBy:function(e,t){if(this.isUICalculateCol(e))return;var n=this._getOrderBy(e);if(null!==t&&undefined!==t)n?n.type=t:this.orderBys.push({relation:e,type:t});else if(n){var r=this.orderBys.indexOf(n);r>=0&&this.orderBys.splice(r,1)}},_getOrderBy:function(e){var t;return $.each(this.orderBys,function(n,r){if(r.relation==e)return t=r,!1}),t},getOrderBy:function(e){var t=this._getOrderBy(e);return t?t.type:t},clearOrderBy:function(){this.orderBys=[]},getOrderBys:function(){var e="";for(var t=0;t<this.orderBys.length;t++){var n=this.orderBys[t];e+=(e!==""?",":"")+n.relation+(0===n.type?" DESC":" ASC")}return e},sort:function(e){this.allDatas.sort(e);var t={source:this,changedSource:this,type:"sort",selfChanged:!0};this.doDataChanged(t)},exchangeRow:function(e,t){var n=this.allDatas.indexOf(e);if(n<0)return;var r=this.allDatas.indexOf(t);if(r<0)return;this.allDatas.splice(n,1,t),this.allDatas.splice(r,1,e);var i={source:this,changedSource:this,row1:e,row2:t,type:"exchangeRow",selfChanged:!0};this.doDataChanged(i)},moveRowTo:function(e,t,n){if(e&&t){var r=e.parent()&&e.parent().rows||e.data.allDatas,i=t.parent()&&t.parent().rows||t.data.allDatas,s=r.indexOf(e);if(s<0)return;var o=i.indexOf(t);if(o<0)return;n&&o++,r.splice(s,1),i.splice(o,0,e),e.row.userdata.parent=t.row.userdata.parent;var u=this.getParentRelation();u&&e.val(u,t.val(u)),this.doDataChanged({source:t.data,row1:e,row2:t,after:n,changedSource:t.data,type:"moveRow",selfChanged:!0})}},getResultRelations:function(){var e=null;for(var t in this.defCols)this.isUICalculateCol(t)||(e=null!==e?e+this.delim+t:t);return e},getColumnIDs:function(){var e=null;for(var t in this.defCols)e=null!==e?e+this.delim+t:t;return e},getAggRelations:function(){var e="";for(var t in this.defAggCols)e+=""!==e?this.delim+t:t;return e},doDataChanged:function(e){var t=e.type;e.selfChanged&&["new","clear","delete","remove","loadData","refresh","valueChanged"].indexOf(t)>=0&&this._updateShareData();var n={};this.hasListener(Data.EVENT_DATA_CHANGE)&&(justep.Util.apply(n,e),this.fireEvent(Data.EVENT_DATA_CHANGE,n));if(this.master&&this.master.masterData){var r=this.master.masterData;r&&(n=$.extend({},e),n.source=r,n.selfChanged=!1,r.doDataChanged(n))}},attachEvents:function(events){if(!events)return;typeof events=="string"&&(events=eval("("+events+")"));if(!events)return;for(var o in events){var func=events[o];if(typeof func=="string")with(this.getModel()||window)func=eval("("+func+")");(typeof func=="function"||func&&func.operation||$.isArray(func))&&this.on(o,func,this.getModel())}},_clear:function(e){this.setOffset(0,e),(!e||this.isChild(this.getCurrentRow(!0),e))&&this.currentRow.set();var t,n=null,r;if(!e){t=this.allDatas.get();for(n=0,r=t.length;n<r;n++)this._clear(t[n]);this.allDatas.removeAll(),this.deleteDatas.removeAll()}else{if(e.rows){t=e.rows.get();for(n=0,r=t.length;n<r;n++)this._clear(t[n]);e.rows.removeAll()}var i=this.deleteDatas.get();for(n=0;n<i.length;n++)this.isChild(i[n],e)&&this.deleteDatas.splice(n,1)}},isChild:function(e,t){if(!e)return!1;var n=e.parent();return n===t?!0:n?this.isChild(n,t):!1},clear:function(e){this._clear(e);var t={};t.source=this,t.changedSource=this,t.type="clear",t.selfChanged=!0,t.parent=e,this.doDataChanged(t)},_reloadDefByUserData:function(e,t){t||justep.Util.apply(this.userdata,e),typeof e=="object"&&(e.hasOwnProperty("sys.loaded")&&this._setLoaded(e["sys.loaded"],t),e.hasOwnProperty("sys.count")&&this.setTotal(e["sys.count"],t),e.hasOwnProperty("sys.offset")&&this.setOffset(e["sys.offset"],t))},_rows2indexMapping:function(e){var t={},n=e?e.rows:this.allDatas;if(n&&Bind.validation.utils.isObservableArray(n)){n=n.peek();for(var r=0;r<n.length;r++){var i=n[r],s=i.ref(this.idColumn);Bind.isObservable(s)&&(t[s.peek()]=i)}}return t},loadData:function(e,t,n,r,i){return this._loadData(e,t,n,r,i,!0)},_loadData:function(e,t,n,r,i,s){r=undefined===r?-1:r;var o=[];$.isArray(e)&&(e={rows:e});if(e&&("table"==e["@type"]||$.isArray(e.rows))){t||this._clear(n),this._reloadDefByUserData(e.userdata,n);var u=i?this._rows2indexMapping(n):{},a=e.rows?e.rows:[],f=[];for(var l=0;l<a.length;l++){var c=$.extend(!0,{},a[l]);c.userdata&&c.userdata.id&&(c[this.idColumn]=c.userdata.id,delete c.userdata.id);var h=this.add(c,n,!0,!0),p=h.ref(this.idColumn),d;Bind.isObservable(p)&&(d=p.peek());var v=u[d];v?(v.assign(h),v.userdata=h.userdata):(f.push(h),i&&d!==undefined&&(u[d]=h)),o.push(h),c.rows&&o.push.apply(o,this.loadData(c,t,h))}n?n.rows?-1==r?n.rows.push.apply(n.rows,f):n.rows.splice.apply(n.rows,[r,0].concat(f)):n.rows=Bind.observableArray(f):-1==r?this.allDatas.push.apply(this.allDatas,f):this.allDatas.splice.apply(this.allDatas,[r,0].concat(f));if(s){var m={source:this,changedSource:this,type:"loadData",selfChanged:!0};this.doDataChanged(m)}}return o},isExist:function(e){return this.exist(e)},exist:function(e){var t=!1;return this.eachByPeek(function(n){e==this.getRowID(n.row)&&(n.cancel=!0,t=!0)},this),t},getUserData:function(e,t){var n=t?t.row.userdata[e]:this.userdata[e];return Bind.isObservable(n)?n.peek():n},getAggregateValue:function(e,t){return this.getUserData(e,t)},aggVal:function(e,t){var n=t?t.row.userdata[e]:this.userdata[e];return Bind.isObservable(n)||(n=Bind.observable(),t?t.row.userdata[e]=n:this.userdata[e]=n),Bind.isObservable(n)?n.get():n},setUserData:function(e,t,n){var r=n?n.row.userdata:this.userdata;Bind.isObservable(r[e])?r[e].set(t):r[e]=Bind.observable(t)},find:function(e,t,n,r,i,s){var o=[],u=0;t&&e&&(u=t.length>e.length?e.length:t.length);if(u>0){var a=s?"eachAll":"each";this[a](function(s){var a=!0,f=s.row;for(var l=0;l<u;l++){var c=this.getValue(e[l],f);if(typeof c=="string"){c=r?c.toLowerCase():c;var h=r?(t[l]+"").toLowerCase():t[l];a=a&&(i?c.indexOf(h)!=-1:c==h)}else a=t[l]==c;if(!a)break}a&&(o.push(f),n&&(s.cancel=!0))},this)}return o},isValid:function(e){return this._getSelfValid(e)&&function(){for(var t=0;t<this.slaveDatas.length;t++)if(!this.slaveDatas[t].isValid(e))return!1;return!0}.call(this)},getInvalidInfo:function(e){var t=[],n=this._getSelfInvalidInfo(e);n&&t.push(n);for(var r=0;r<this.slaveDatas.length;r++){var i=this.slaveDatas[r].getInvalidInfo(e);i&&t.push(i)}return t.join("\n")},convert:function(e,t){return Data.convert(e,t)},_filterBy:function(){var e,t;return this.master?(e=Bind.computed(function(){var e=this.master.masterData,n=this._isModelConctructed.get(),r=e.getCurrentRow(),s=e.getRowID(r),o=this.allDatas.get();if(undefined===r||null===r||!n)return this.currentRow.set(null),this.setTotal(0),this.setOffset(0),[];var u=this.byMaster[s];if(!u||!u.loaded){var a={source:this,masterRow:r,loaded:Data.STATE.NEW===e.getRowState(r)};this.fireEvent(Data.EVENT_LOAD_SLAVEDATA,a),!a.loaded&&this.autoLoad&&Data.STATE.NEW!==e.getRowState(r)&&(a.loaded=this._refreshData({append:!0,masterLoading:!0,offset:0})),u?u.loaded=a.loaded:this.byMaster[s]={loaded:a.loaded}}var f=[];for(t=0;t<o.length;t++){var l=o[t];Bind.unwrap(l.ref(this.master.relation).get())===s&&f.push(l)}this.clientFilter&&(f=this._clientFilter(f));var c=null;return u&&u.loaded?(c=!u.current&&f.length>0?f[0]:u.current,u.offset!==undefined?this.setOffset(u.offset):"",u.total!==undefined?this.setTotal(u.total):""):f.length>0?c=f[0]:this.currentRow.set(null),this.to(c),f},this),e.owner=this,e):this.clientFilter?(e=Bind.computed(function(){var e=this._isModelConctructed.get();if(!e)return[];var t=this.allDatas.get(),n;if(this.clientFilter){t=this._clientFilter(t);var r=this.getCurrentRow(!0);$.each(t,function(e,t){if(t===r)return n=r,!1})}return n&&this.currentRow.set(n),t.length>0?this.currentRow.set(t[0]):this.currentRow.set(null),t},this),e.owner=this,e):this.allDatas},bindRules:function(e,t,n,r){return t&&e.extend({validatable:{enable:!0,rules:t,isModified:n,ctx:r}}),e},_doReadonly:function(e,t){return this.readonly.get()||e instanceof Expr&&Expr.eval(e,t.$row,t)},bindReadonly:function(e,t,n){return n.caller=this,e.extend({readonly:{readonlyFN:this._doReadonly,readonlyDef:t,ctx:n}}),e},bindCalculate:function(e,t,n){var r=Bind.computed({read:function(){if(!this._inited)return"";var r=e.peek();n.$val=r;var i=Expr.eval(t,n.$row,n);return i!==r&&window.setTimeout(function(){e.set(i)},1),i},write:function(t){e.set(t)}},this);return r.target=e,r},getParentRelation:function(){return this.defTreeOption.isTree?this.defTreeOption.option.parentRelation:""},bindValueChange:function(e,t){var n=Bind.observable(e);return n.subscribe(function(e){e.newValue!==e.oldValue&&(e.source=t.data,e.row=t.row,e.col=t.col,t.handler.call(t.caller,e))},null,"changing"),n.subscribe(function(e){var n={source:t.data,row:t.row,col:t.col,value:e};t.handler.call(t.caller,n,!0)}),n},disableRecordChange:function(){this._disableRecordChange=!0},enabledRecordChange:function(){this._disableRecordChange=!1},canRecordChange:function(){return!this._disableRecordChange},isCalculateCol:function(e){if(e){"string"==typeof e&&(e=this.defCols[e]);if("object"==typeof e)return"EXPRESS"===e.relation||"STATISTICAL"==e.relation}},isUICalculateCol:function(e){if(e){"string"==typeof e&&(e=this.defCols[e]);if("object"==typeof e)return!e.isBiz&&("EXPRESS"===e.relation||"STATISTICAL"==e.relation)}},_doValueChange:function(e,t){if(e.col===this.versionRelation||!this.canRecordChange())return;if(!t){this.fireEvent(Data.EVENT_VALUE_CHANGE,e);if(!this.isCalculateCol(e.col)&&e.oldValue!==e.newValue){var n=e.row;if(n){var r=n.row.userdata.recordState;if(r!==Data.STATE.NEW){var i=n.row[e.col];1!==i.changed&&(i.originalValue=e.oldValue,n.row.userdata.recordState=Data.STATE.EDIT,i.changed=1,n.row.userdata.isModified.set(!0),this.isModified.set(!0))}}}}else this.fireEvent(Data.EVENT_VALUE_CHANGED,e),e.changedSource=this,e.type="valueChanged",e.selfChanged=!0,this.doDataChanged(e);Data.debug&&console.log("行["+e.rowID+"]列["+e.col+"]changed,"+"old:"+e.oldValue+",newValue:"+e.newValue)},getRowByID:function(e,t){if(e!==undefined&&e!==null){var n=null,r=t?"eachAll":"each";return this[r](function(t){e==this.getRowID(t.row)&&(t.cancel=!0,n=t.row)},this),n}return this.getCurrentRow(!0)},getValue:function(e,t){t||(t=this.getCurrentRow());var n=t?t.ref(e):undefined,r=this.defCols?this.defCols[e]:null;return this.convert(Bind.isObservable(n)?n.get():n,r?r.type:"String")},getOriginalValue:function(e,t){t||(t=this.getCurrentRow());var n=t?t.row[e]:undefined,r=this.defCols?this.defCols[e]:null;return this.convert(n.originalValue,r?r.type:"String")},setValue:function(e,t,n){n||(n=this.getCurrentRow(!0));var r=n?n.ref(e):undefined,i=this.defCols[e],s=i?i.type:"String";Bind.isObservable(r)&&(t instanceof Data.ErrorValue&&(t=t.value),s==="DateTime"?t=dateTime2Val(t):s==="Date"?t=date2Val(t):s==="Time"&&(t=time2Val(t)),r.set(t))},getValueByID:function(e,t){var n=this.getRowByID(t,!0);if(n)return this.getValue(e,n)},setValueByID:function(e,t,n){var r=this.getRowByID(n,!0);if(!r){var i=new justep.Message(justep.Message.JUSTEP231105,n);throw justep.Error.create(i)}this.setValue(e,t,r)},getRowState:function(e){return e&&e.row.userdata&&e.row.userdata.recordState?e.row.userdata.recordState:Data.STATE.NONE},setRowState:function(e,t){e&&e.row.userdata&&(e.row.userdata.recordState=t,(t===Data.STATE.NEW||t===Data.STATE.EDIT&&Bind.isObservable(e.row.userdata.isModified))&&e.row.userdata.isModified.set(!0))},getRowID:function(e){return e===undefined&&(e=this.getCurrentRow(!0)),e?e.ref(this.idColumn).get():undefined},getIDs:function(){var e=[];return this.eachByPeek(function(t){e.push(this.getRowID(t.row))},this),e},getRowIndex:function(e){var t=this.datas.get();return $.isArray(t)?t.indexOf(e):-1},to:function(e){typeof e=="string"&&(e=this.getRowByID(e));if((e instanceof Data.Row||e===undefined||e===null)&&e!==this.getCurrentRow(!0)){var t={source:this,row:e,originalRow:this.getCurrentRow(!0),cancel:!1};this.fireEvent(Data.EVENT_INDEX_CHANGING,t);if(t.cancel)return;this.currentRow.set(e),this._updateShareDataCurrentIndex(),this.fireEvent(Data.EVENT_INDEX_CHANGED,t)}},getCount:function(e){if(!this.defTreeOption.isTree)return this.datas.get().length;var t=0;return this.eachByPeek(function(){t++},this,e),t},next:function(){var e=this.getCurrentRow(!0),t=!1;this.eachByPeek(function(n){t&&(this.to(n.row),n.cancel=!0,t=!1),n.row==e&&(t=!0)},this)},pre:function(){var e=this.getCurrentRow(!0),t=null;this.eachByPeek(function(n){n.row==e&&(null!==t&&this.to(t),n.cancel=!0,t=null),t=n.row},this)},first:function(){this.to(this.getFirstRow())},last:function(){this.to(this.getLastRow())},getFirstRow:function(){var e=this.datas.get();return e.length>0?e[0]:null},getLastRow:function(){var e=this.datas.get();return e.length>0?this._lastRow(e):null},getCurrentRow:function(e){return this.currentRow[e?"peek":"get"]()},getCurrentRowID:function(){return this.getRowID(this.getCurrentRow(!0))},_lastRow:function(e){var t=e.length,n=e[t-1];return t>0&&n.rows?this._lastRow(n.rows.get()):n},bof:function(){var e=this.datas.get();return e.length>0?this.getFirstRow()===this.getCurrentRow():!1},eof:function(){var e=this.datas.get();return e.length>0?this.getLastRow()===this.getCurrentRow():!1},isLeaf:function(e){return this.defTreeOption.isTree&&e?e.row[this.defTreeOption.option.nodeKindRelation]?Data.NODE_KIND_LEAF==e.ref(this.defTreeOption.option.nodeKindRelation).get():!1:!0},isTree:function(){return this.defTreeOption&&this.defTreeOption.isTree},_getDefaultValue:function(e){var t={},n={$model:this.getModel(),$data:this};for(var r in this.defCols){var i=this.defCols[r];i.defaultValue&&(typeof i.defaultValue=="string"&&(i.defaultValue=new Expr(i.defaultValue)),i.defaultValue instanceof Expr&&(n.$col=r,t[r]=Expr.eval(i.defaultValue,n.$data,n)))}if(!$.isEmptyObject(t)){e=$.isArray(e)?e:[{}];var s=[];for(var o=0;o<e.length;o++)s.push($.extend({},t,e[o]));e=s}return e},newData:function(e){var t=-1,n=null,r=null,i=null,s=null,o=!1,u={cancel:!1,option:e,options:e,source:this};this.fireEvent(Data.EVENT_NEWDATA_BEFORE,u);if(u.cancel)return null;arguments.length==1&&typeof e=="object"&&(t=e.hasOwnProperty("index")?e.index:t,n=e.parent,r=e.defaultValues,i=e.onSuccess,s=e.onError);var a=null;if(this.hasListener(Data.EVENT_NEWDATA)){u={data:a,option:e,options:e,async:!1,source:this},this.fireEvent(Data.EVENT_NEWDATA,u),a=u.data,o=u.async;if(a)for(var f=0;f<a.length;f++){var l=a[f];l.userdata||(l.userdata={}),l.userdata.recordState=Data.STATE.NEW}}else r=this._getDefaultValue(r),a=this.doNewData(r,e);if(!a)return null;r=this.loadData(a,!0,n,t);if(r.length>0){if(this.isTree()){var c=this.getTreeOption();if(c.nodeKindRelation){for(var h=0;h<r.length;h++){var p=r[h];p.val(c.nodeKindRelation,Data.NODE_KIND_LEAF)}n&&n.val(c.nodeKindRelation,"")}}this.to(r[0])}return this.opened=!0,u={rows:r,option:e,options:e,source:this},this.fireEvent(Data.EVENT_NEWDATA_AFTER,u),u.changedSource=this,u.type="new",u.selfChanged=!0,this.doDataChanged(u),this._setLoaded(!0,n),i&&$.isFunction(i)&&i({source:this,option:e,options:e,rows:r}),r},doNewAfter:function(){},doNewData:function(e,t){t=t||{};if(!e||e.length<=0)e=[{}];var n={rows:[],userData:{},"@type":"table"};for(var r=0;r<e.length;r++){var i=e[r];i.userdata||(i.userdata={}),t.disableRecordChange||(i.userdata.recordState=Data.STATE.NEW),n.rows.push(i)}return n},_beginBatch:function(){return!0},_cancelBatch:function(){return!0},_endBatch:function(){return!0},saveData:function(e){var t=null,n=null,r=!0,i=!1,s=!1,o;arguments.length==1&&typeof e=="object"&&(i=!!e.ignoreInvalid,undefined!==e.useTrans&&(r=!!e.useTrans),t=e.onSuccess,n=e.onError,e=$.extend({},e));var u=!1;if(!this.isChanged())return!0;if(!i&&!this.isValid())throw justep.Error.create(this.getInvalidInfo());if(!1!==r&&!this._beginBatch()){var a=new justep.Message(justep.Message.JUSTEP231019);throw justep.Error.create(a)}try{var f={cancel:!1,source:this,options:e};this.fireEvent(Data.EVENT_SAVEDATA_BEFORE,f);if(f.cancel)return!1!==r&&this._cancelBatch(),!1;if(this.hasListener(Data.EVENT_SAVEDATA))f={cancel:!1,source:this,async:!1,promise:o,options:e},this.fireEvent(Data.EVENT_SAVEDATA,f),s=f.async,u=!f.cancel,o=f.promise;else{var l=this.doSaveData(e);$.isPlainObject(l)?(u=l.success,s=l.async,o=l.promise):u=l}if(!u)return!1!==r&&this._cancelBatch(),!1;if(o&&$.isFunction(o.then)){var c=this;o.then(function(){c.doSaveAfter(!0,e)},function(){c.doSaveAfter(!1,e)})}else s||this.doSaveAfter(u,e);f={cancel:!1,options:e,source:this},this.fireEvent(Data.EVENT_SAVEDATA_AFTER,f);if(f.cancel)return!1!==r&&this._cancelBatch(),!1}catch(h){!1!==r&&this._cancelBatch();var a=new justep.Message(justep.Message.JUSTEP231020,h.message||h);throw justep.Error.create(a)}return!1!==r&&this._endBatch(),!0},doSlaveDataSave:function(){var e=this.slaveDatas.length;for(var t=0;t<e;t++){var n=this.slaveDatas[t];if(n&&!n.saveData({useTrans:!1,ignoreInvalid:!0}))return!1}return!0},doSaveData:function(e){var t=e&&e.onlySelf||!1;return t||this.doSlaveDataSave()},doSaveAfter:function(e,t,n){t=t||{},n=n||{};var r=t.onError,i=t.onSuccess;n.source||(n.source=this),e?(this.applyUpdates(n,t),this._updateShareData(!0),i&&$.isFunction(i)&&i(n),this.fireEvent(Data.EVENT_SAVE_COMMIT,n)):(r&&$.isFunction(r)&&r(n),this.hasListener(Data.EVENT_SAVEDATA_ERROR)&&this.fireEvent(Data.EVENT_SAVEDATA_ERROR,n))},applyUpdates:function(e,t){this.disableRecordChange();try{var n=this.deleteDatas.get();n&&$.isArray(n)&&n.splice(0,n.length),this.eachAllByPeek(function(e){var t=e.row.row,n=t.userdata.recordState;if(this.updateMode=="whereVersion"&&Data.STATE.EDIT==n){var r=this.getVersionColumn();if(r&&t[r]){var i=parseInt(t[r].value.peek(),10)+1;t[r].value.set(i)}}if(Data.STATE.EDIT==n||Data.STATE.NEW==n)for(var s in this.defCols)t[s].changed=0,t[s].originalValue=t[s].value.peek();t.userdata.recordState=Data.STATE.NONE},this)}finally{this.enabledRecordChange()}},_existParamContext:function(e,t){var n=e||this.getModel();return n&&n.params&&n.params.hasOwnProperty(t)},getVersionColumn:function(){return this.versionRelation},loadNextPageData:function(e){if(this.limit==-1)return;return e=e||{append:!0},this.isLoaded()?this._refreshData(e):this.refreshData(e)},loadAllPageData:function(e){e=e||{};if(this.limit==-1&&!this.isLoaded())return this.refreshData(e);var t=this.getTotal(e.parent),n=this.getOffset(e.parent);if(t<=n)return;if(t<1)return;var r=this.limit;try{return e.append=!0,e.limit=t,this._refreshData(e)}finally{this.limit=r}},loadPageData:function(e,t){return this.limit==-1||1==e?this.refreshData(t):(t=t||{},e=e<1?1:e,t.offset=(e-1)*this.limit,t.append=!1,this._refreshData(t))},refreshData:function(e){return e=e||{},this.definition.offset?e.offset=this.definition.offset:e.offset=0,e.append=e.append!==!0?!1:!0,this._refreshData(e)},_clsSlaveDatasState:function(){var e=this.slaveDatas;$.isArray(e)&&$.each(e,function(e,t){t._clear(),t._clsSlaveDatasState(),t.byMaster={}})},_confirm:function(e,t,n,r){r?confirm(e)?t&&t():n&&n():justep.Util.confirm(e,t,n)},_refreshData:function(e){var t=!1,n=!1,r,i=this.getCurrentRow(!0),s=i?this.getRowID(i):null,o={cancel:!1,options:e,source:this};this.fireEvent(Data.EVENT_REFRESHDATA_BEFORE,o);if(o.cancel)return!1;e=$.extend({},e);var u=function(){e&&"number"==typeof e.offset&&this.setOffset(e.offset,e.parent),e&&"number"==typeof e.limit&&(this.limit=e.limit);var i=this.getOffset(e?e.parent:null);e._sys_={oldRowID:s,offset:i};if(this.master&&this.master.masterData&&!e.append){this.byMaster={};var u=this.master.masterData,a=u.getCurrentRow(!0),f=u.getRowID(a);this.byMaster[f]={loaded:!0}}if(this.hasListener(Data.EVENT_REFRESHDATA))o={cancel:!1,limit:this.limit,offset:this.getOffset(e.parent),options:e,async:n,promise:null,source:this},this.fireEvent(Data.EVENT_REFRESHDATA,o),n=o.async,t=!o.cancel,r=o.promise;else{var l=this.doRefreshData(e);$.isPlainObject(l)?(t=l.success,n=l.async,r=l.promise):t=l}if(r&&$.isFunction(r.then)){var c=this;r.then(function(){c.doRefreshAfter(!0,e)},function(){c.doRefreshAfter(!1,e)})}else n||this.doRefreshAfter(t,e)}.bind(this),a=this.confirmRefresh;return e&&undefined!==e.confirm&&(a=e.confirm),e&&e.append?u():this.isChanged()&&a?this._confirm(this.confirmRefreshText,u,null,!e.async):u(),t},doRefreshAfter:function(e,t,n){n=n||{},n.source||(n.source=this);if(!t){var r=this.getOffset(t?t.parent:null);t={_sys_:{offset:r}}}var i=t.onError,s=t.onSuccess,o=this;if(e){this.opened=!0,t.append||this._clsSlaveDatasState(),this._setLoaded(!0,t?t.parent:null);if(!t||!t.append){var u=t._sys_.oldRowID,a=u!==null?this.getRowByID(u):null;a?a&&this.to(a):this.first()}this.limit!=-1&&this.setOffset(t._sys_.offset+this.limit,t?t.parent:null);var f={limit:this.limit,offset:this.getOffset(t?t.parent:null),options:t,source:this,success:e,changedSource:this,type:"refresh",selfChanged:!0};t.masterLoading?setTimeout(justep.Util.bindModelFn(this.getModel(),function(){o.doDataChanged(f)}),1):this.doDataChanged(f),s&&$.isFunction(s)&&s(n)}else i&&$.isFunction(i)&&i(n),this.hasListener(Data.EVENT_REFRESHDATA_ERROR)&&(t.masterLoading?setTimeout(justep.Util.bindModelFn(this.getModel(),function(){o.fireEvent(Data.EVENT_REFRESHDATA_ERROR,n)}),1):this.fireEvent(Data.EVENT_REFRESHDATA_ERROR,n));var l={limit:this.limit,offset:this.getOffset(t?t.parent:null),options:t,source:this,success:e};t.masterLoading?setTimeout(justep.Util.bindModelFn(this.getModel(),function(){o.fireEvent(Data.EVENT_REFRESHDATA_AFTER,l)}),1):this.fireEvent(Data.EVENT_REFRESHDATA_AFTER,l)},doRefreshData:function(options){return this.definition.initData&&this.loadData({rows:eval("("+this.definition.initData+")"),"@type":"table"}),!0},deleteAllData:function(e){var t=this.datas.peek();if($.isArray(t)){t=t.slice(0);var n=this.deleteData(t,e),r={};return r.source=this,r.changedSource=this,r.type="clear",r.selfChanged=!0,this.doDataChanged(r),n}return!0},deleteData:function(e,t){var n=!1,r=t&&t.async||!1,i;e=e?e:[this.getCurrentRow(!0)],e instanceof Data.Row&&(e=[e]);var s={cancel:!1,source:this,option:t,options:t,deleteRows:e};this.fireEvent(Data.EVENT_DELETEDATA_BEFORE,s);if(s.cancel)return!1;var o=this.confirmDelete;t&&undefined!==t.confirm&&(o=t.confirm),t=$.extend({},t),t._sys_={rows:e};var u=function(){if(this.hasListener(Data.EVENT_DELETEDATA))s={cancel:!1,source:this,option:t,options:t,async:r,promise:null,deleteRows:e},this.fireEvent(Data.EVENT_DELETEDATA,s),r=s.async,n=!s.cancel,i=s.promise;else{var o=0,u,a;if(!this.directDeleteMode){r=!1;if(!e)return!1;for(o=e.length-1;o>=0;o--)u=e[o],Data.STATE.NEW!=this.getRowState(u)&&(this.setRowState(u,Data.STATE.DELETE),this.deleteDatas.push(u),a=this.getTotal(u.row.userdata.parent)-1,this.setTotal(a>=0?a:0,u.row.userdata.parent)),this.remove(u);n=!0}else{t=$.extend({},t);var f=t.onSuccess,l=this;t.onSuccess=function(t){for(o=0;o<e.length;o++){var n=e[o],r=l.getTotal(n.row.userdata.parent)-1;l.setTotal(r>=0?r:0,n.row.userdata.parent),l.remove(n)}"function"==typeof f&&f(t)};var c=this.doDirectDeleteData(e,t);$.isPlainObject(c)?(n=c.success,r=c.async,i=c.promise):n=c}}if(i&&$.isFunction(i.then)){var h=this;i.then(function(){h.doDeleteAfter(!0,t)},function(){h.doDeleteAfter(!1,t)})}else r||this.doDeleteAfter(n,t)}.bind(this);return o?this._confirm(this.confirmDeleteText,u,null,!r):u(),n},doDeleteAfter:function(e,t,n){n=n||{},n.source||(n.source=this);var r=t.onError,i=t.onSuccess;e?i&&$.isFunction(i)&&i(n):(r&&$.isFunction(r)&&r(n),this.hasListener(Data.EVENT_DELETEDATA_ERROR)&&this.fireEvent(Data.EVENT_DELETEDATA_ERROR,n));var s={source:this,deleteRows:t._sys_.rows};this.fireEvent(Data.EVENT_DELETEDATA_AFTER,s),s.changedSource=this,s.type="delete",s.selfChanged=!0,this.doDataChanged(s)},doDirectDeleteData:function(e,t){return{success:!0,async:!1}},_bindValue:function(e,t,n){$.isPlainObject(e.row[t])||(e.row[t]={changed:0,value:e.row[t],originalValue:null}),e.row[t].value=this.bindValueChange(e.row[t].value,{data:this,handler:this._doValueChange,caller:this,rowID:n,row:e,col:t})},_bindRule:function(e,t,n){var r=this.defCols[t];r.calculate&&(typeof r.calculate=="string"&&(r.calculate=new Expr(r.calculate)),r.calculate instanceof Expr&&(e.row[t].value=this.bindCalculate(e.row[t].value,r.calculate,{$model:this.getModel(),$data:this,$row:e,$rowID:n,$col:t}))),this.bindRules(e.row[t].value,r.rules,e.row.userdata.isModified,{$model:this.getModel(),$data:this,$row:e,$rowID:n,$col:t,$colName:t}),typeof r.readonly=="string"&&(r.readonly=new Expr(r.readonly)),this.bindReadonly(e.row[t].value,r.readonly,{$model:this.getModel(),$data:this,$row:e,$rowID:n,$col:t}),e.row[t].value.define={data:this,row:e,col:t,defCol:r}},add:function(e,t,n,r){e=e||{};var i;for(var s in this.defCols)i=this.defCols[s].type,i==="DateTime"?e[s]=dateTime2Val(e[s]):i==="Date"?e[s]=date2Val(e[s]):i==="Time"?e[s]=time2Val(e[s]):e[s]=e[s];this.master&&!e[this.master.relation]&&(e[this.master.relation]=this.master.masterData.getRowID(this.master.masterData.getCurrentRow(!0)));var o=e[this.idColumn];typeof o=="object"&&(o=o.value);var u=e;u.userdata||(u.userdata={}),t&&!Bind.isObservable(t.rows)&&(t.rows=Bind.observableArray()),u.userdata.parent=t;var a=u.userdata.recordState==Data.STATE.NEW||u.userdata.recordState==Data.STATE.EDIT;u.userdata.isModified=Bind.observable(a),a&&this.isModified.set(!0),u=new Row(this,u);for(s in this.defCols)this._bindValue(u,s,o);for(s in this.defCols)this._bindRule(u,s,o);return r||(t?t.rows.push(u):this.allDatas.push(u)),n||this.to(u),u},remove:function(e){e=e?e:this.getCurrentRow(!0);var t=e.row.userdata.parent,n=t?t.rows:this.allDatas,r=n.indexOf(e),i=n.get().length;if(r>=0&&r<i){var s=e===this.getCurrentRow(!0),o=t?t.rows:this.datas,u=Bind.utils.arrayIndexOf(o.get(),e);n.splice(r,1);var a={};a.source=this,a.changedSource=this,a.type="remove",a.row=e,a.selfChanged=!0,this.doDataChanged(a);if(s){var f=this.getCount();i=o.get().length,f<=0?this.to(null):u<i?this.to(o.get()[u]):u>=i&&i>0?this.to(o.get()[u-1]):this.to(t)}if(t&&o.get().length<=0&&this.isTree()){var l=this.getTreeOption();l.nodeKindRelation&&t&&t.val(l.nodeKindRelation,Data.NODE_KIND_LEAF)}}},_masterFilter:function(e,t){if(!this.master)return!0;var n=this.master.masterData;if(t){var r=t.ref(n.idColumn);if(Bind.isObservable(r))return e===r.get()}},_setTreeFilter:function(e){this.setFilter("_treeFilter_",e)},_aggregate:function(e,t,n,r){var i=r?this.allDatas.get():this.datas.get(),s=0,o=0,u=null,a=null,f=n&&typeof n=="function",l=typeof n=="object"?n:undefined;for(var c=0;c<i.length;c++){var h=this.master?i[c].ref(this.master.relation).get():null;if(!f&&l===undefined||f&&n({source:this,data:this,row:i[c]})||l!==undefined&&this._masterFilter(h,l)){o++;if(t){var p=this.defCols[t],d=this.convert(i[c].ref(t).get(),p.type);if(d===undefined||d===null||d instanceof Data.ErrorValue)continue;s=justep.Number.accAdd(s,d),a=a===null?d:a<d?d:a,u=u===null?d:u>d?d:u}}}if("count"===e)return o;if("avg"===e)return justep.Number.accDiv(s,o);if("sum"===e)return s;if("min"===e)return u;if("max"===e)return a},Count:function(e){return this._aggregate("count",null,e)},countByAll:function(e){return this._aggregate("count",null,e,!0)},count:function(e){return this._aggregate("count",null,e)},Avg:function(e,t){return this._aggregate("avg",e,t)},avgByAll:function(e,t){return this._aggregate("avg",e,t,!0)},avg:function(e,t){return this._aggregate("avg",e,t)},Sum:function(e,t){return this._aggregate("sum",e,t)},sumByAll:function(e,t){return this._aggregate("sum",e,t,!0)},sum:function(e,t){return this._aggregate("sum",e,t)},Min:function(e,t){return this._aggregate("min",e,t)},minByAll:function(e,t){return this._aggregate("min",e,t,!0)},min:function(e,t){return this._aggregate("min",e,t)},Max:function(e,t){return this._aggregate("max",e,t)},maxByAll:function(e,t){return this._aggregate("max",e,t,!0)},max:function(e,t){return this._aggregate("max",e,t)},getChangedIDs:function(e,t){var n=this.getChangedRows(e),r=[];return $.isArray(n)&&$.each(n,function(e,t){r.push(t.getID())}),r.join(t||",")},getChangedRows:function(e){if(Data.STATE.DELETE===e)return this.deleteDatas.peek();var t=[];return this.eachAllByPeek(function(n){var r=n.row;e==this.getRowState(r)&&t.push(r)},this),t},_row2Json:function(e,t,n,r){var i={};for(var s in this.defCols){var o=$.isArray(n)?$.inArray(s,n)>-1:!1;(r||!r&&s!==this.idColumn)&&!o&&(!t||t&&!this.isUICalculateCol(s))&&(i[s]=r?e.ref(s):e.row[s])}return i.userdata=$.extend({},e.row.userdata),r||(i.userdata.id=e.row[this.idColumn]),delete i.userdata.parent,Bind.toJS(i)},_rows2Json:function(e,t,n,r){var i="",s="",o="";for(var u in this.defCols){var a=$.isArray(n)?$.inArray(u,n)>-1:!1;if(u!==this.idColumn&&!a&&(!t||t&&!this.isUICalculateCol(u))){var f=this.defCols[u];i+=""!==i?","+u:u,s+=""!==s?","+f.type:f.type,o+=""!==o?","+f.define:f.define}}return{"@type":"table",rows:e,userdata:$.extend(this.userdata,{idColumnDefine:this.defCols[this.idColumn].define,idColumnName:this.idColumn,idColumnType:this.defCols[this.idColumn].type,model:this.dataModel,relationAlias:i,relationTypes:s,relations:o,updateMode:this.updateMode})}},toJson:function(e){var t=!1,n=!1,r=[],i=!1;arguments.length==1&&typeof e=="object"?(t=e.onlyChanged,n=e.excludeCalculateCol,r=e.excludeCols||[],i=e.format==="simple"):(arguments.length>=1&&(t=arguments[0]),arguments.length>=2&&(n=arguments[1]));var s=[];this.eachAllByPeek(function(e){var o=e.row,u=o.row.userdata.recordState;(!t||Data.STATE.EDIT==u||Data.STATE.NEW==u||Data.STATE.DELETE==u)&&s.push(this._row2Json(o,n,r,i))},this);var o=this.deleteDatas.get();if(o.length>0){var u=o.length;for(var a=0;a<u;a++)s.push(this._row2Json(o[a],n,r,i))}return this._rows2Json(s,n,r,i)}});Data.Row=Row,Data.registerData=function(e,t,n){e instanceof Model&&(e[t]=n,e.registerComponent(t,n))},Data.unRegisterData=function(e,t){e instanceof Model&&(e.unRegisterComponent(t),delete e[t])},Data.$=function(e,t){return e instanceof Model?e.getComponent(t):null},Data.each=function(e,t){if(!e||!$.isFunction(t))return;for(var n in e){var r=e[n];if(r instanceof Data){var i={data:r,cancel:!1};t(i);if(i.cancel)return}}},Data.getMainData=function(e){var t=e.__sys__||(e.__sys__={});return t.mainData||Data.each(e,function(e){e.data.isMain&&(t.mainData=e.data,e.cancel=!0)}),t.mainData},Data.UUID=function(){var e=justep.UUID.createUUID();return e.replace(/-/g,"").toUpperCase()},Data.STATE={NEW:"new",DELETE:"delete",EDIT:"edit",NONE:"none"},Data.EVENT_CREATE="onCreate",Data.EVENT_CUSTOM_SORT="onCustomSort",Data.EVENT_VALUE_CHANGE="onValueChange",Data.EVENT_VALUE_CHANGED="onValueChanged",Data.EVENT_DATA_CHANGE="onDataChange",Data.EVENT_INDEX_CHANGED="onIndexChanged",Data.EVENT_INDEX_CHANGING="onIndexChanging",Data.EVENT_LOAD_SLAVEDATA="onLoadSlave",Data.EVENT_SLAVEDATAS_CHANGED="onSlaveDatasChanged",Data.EVENT_NEWDATA_ERROR="onNewError",Data.EVENT_NEWDATA_CREATEPARAM="onNewCreateParam",Data.EVENT_NEWDATA_BEFORE="onBeforeNew",Data.EVENT_NEWDATA="onCustomNew",Data.EVENT_NEWDATA_AFTER="onAfterNew",Data.EVENT_DELETEDATA_ERROR="onDeleteError",Data.EVENT_DELETEDATA_BEFORE="onBeforeDelete",Data.EVENT_DELETEDATA="onCustomDelete",Data.EVENT_DELETEDATA_AFTER="onAfterDelete",Data.EVENT_REFRESHDATA_ERROR="onRefreshError",Data.EVENT_REFRESHDATA_CREATEPARAM="onRefreshCreateParam",Data.EVENT_REFRESHDATA_BEFORE="onBeforeRefresh",Data.EVENT_REFRESHDATA="onCustomRefresh",Data.EVENT_REFRESHDATA_AFTER="onAfterRefresh",Data.EVENT_SAVEDATA_ERROR="onSaveError",Data.EVENT_SAVEDATA_CREATEPARAM="onSaveCreateParam",Data.EVENT_SAVEDATA_BEFORE="onBeforeSave",Data.EVENT_SAVEDATA="onCustomSave",Data.EVENT_SAVEDATA_AFTER="onAfterSave",Data.EVENT_SAVE_COMMIT="onSaveCommit",Data.EVENT_LOAD_SHARE_DATA="onLoadShareData",Data.LOAD_TREE_ROOT="___tree___root___",Data.NODE_KIND_LEAF="nkLeaf";var date2String=function(){return justep.Date.toString(this,"yyyy-MM-dd")},dateTime2String=function(){return justep.Date.toString(this,"yyyy-MM-dd hh:mm:ss")},time2String=function(){return justep.Date.toString(this,"hh:mm:ss")};return Data.convert=function(e,t){if(t=="String")return e;var n;return-1<$.inArray(t,["Integer","Long"])&&typeof e=="string"?(n=Data.createErrorValue(e),e=justep.String.toInt(e,n)):-1<$.inArray(t,["Double","Float","Decimal"])&&typeof e=="string"?(n=Data.createErrorValue(e),e=justep.String.toFloat(e,n)):t=="Date"&&typeof e=="string"&&e?(e=justep.Date.fromString(e,"yyyy-MM-dd"),e?e.toString=date2String:(n=Data.createErrorValue(e),e=n)):t=="DateTime"&&typeof e=="string"&&e&&(e=justep.Date.fromString(e,"yyyy-MM-ddThh:mm:ss.fff"),e?e.toString=dateTime2String:(n=Data.createErrorValue(e),e=n)),e},Data.str2time=function(e){e=justep.Date.fromString(e,"hh:mm:ss.fff");if(!e){var t=Data.createErrorValue(e);e=t}else e.toString=time2String;return e},Data.ErrorValue=justep.Object.extend({constructor:function(e){this.value=e},toString:function(){return NaN}}),Data.createErrorValue=function(e){var t=new Data.ErrorValue(e);return t},Data.NullValue=justep.BindComponent.NullValue,Data.Rules=Rules,justep.Component.addOperations(Data,{save:{label:justep.Message.getMessage(justep.Message.JUSTEP231003),icon:"glyphicon glyphicon-floppy-disk",init:function(){var e=this,t=this.owner,n=function(){e.setEnable(!t.getReadonly()&&t.isChanged())};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_SAVE_COMMIT,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},method:function(e){return this.owner.saveData()}},"delete":{label:justep.Message.getMessage(justep.Message.JUSTEP231005),icon:"icon-minus",init:function(){var e=this,t=this.owner,n=function(){setTimeout(function(){e.setEnable(!t.getReadonly()&&t.getCount()>0&&!!t.getCurrentRow(!0))},1)};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n),this.owner.on(Data.EVENT_SLAVEDATAS_CHANGED,n)},argsDef:[{name:"rows",displayName:justep.Message.getMessage(justep.Message.JUSTEP231083)}],method:function(e){return this.owner.deleteData(e.rows,{async:!0})}},deleteAll:{label:"删除全部",icon:"icon-minus",init:function(){var e=this,t=this.owner,n=function(){setTimeout(function(){e.setEnable(!t.getReadonly()&&t.getCount()>0)},1)};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_SLAVEDATAS_CHANGED,n)},argsDef:[{name:"force",displayName:"禁止提示"},{name:"confirmText",displayName:"删除提示"}],method:function(e){var t={};return t.async=!0,t.confirm=typeof e.force=="string"?"true"!==e.force:!e.force,t.confirmText=e.confirmText,this.owner.deleteAllData(t)}},"new":{label:justep.Message.getMessage(justep.Message.JUSTEP231006),icon:"icon-plus",init:function(){var e=this,t=this.owner,n=function(){setTimeout(function(){e.setEnable(!t.getReadonly())},1)};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},argsDef:[{name:"defaultValues",displayName:justep.Message.getMessage(justep.Message.JUSTEP231084)},{name:"index",displayName:justep.Message.getMessage(justep.Message.JUSTEP231096)}],method:function(e){return this.owner.newData(e)}},newChild:{label:justep.Message.getMessage(justep.Message.JUSTEP231008),icon:"icon-plus",init:function(){var e=this,t=this.owner,n=function(){setTimeout(function(){e.setEnable(t.isTree()&&!t.getReadonly()&&!!t.getCurrentRow(!0))},1)};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},argsDef:[{name:"parent",displayName:"parent"}],method:function(e){return e.parent=this.owner.getCurrentRow(!0),this.owner.newData(e)}},newBrother:{label:justep.Message.getMessage(justep.Message.JUSTEP231009),icon:"icon-plus",init:function(){var e=this,t=this.owner,n=function(){setTimeout(function(){e.setEnable(t.isTree()&&!t.getReadonly()&&!!t.getCurrentRow(!0))},1)};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},argsDef:[{name:"parent",displayName:"parent"}],method:function(e){var t=this.owner.getCurrentRow(!0);return t&&(e.parent=t.parent()),this.owner.newData(e)}},refresh:{label:justep.Message.getMessage(justep.Message.JUSTEP231007),icon:"icon-refresh",argsDef:[{name:"force",displayName:"禁止提示"}],method:function(e){var t={};return t.async=!0,t.confirm=typeof e.force=="string"?"true"!==e.force:!e.force,this.owner.refreshData(t)}},firstRow:{label:justep.Message.getMessage(justep.Message.JUSTEP231086),icon:"icon-chevron-left",init:function(){var e=this,t=this.owner,n=function(){var n=t.getCount();e.setEnable(n>1&&t.getFirstRow()!==t.getCurrentRow(!0))};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n),this.owner.on(Data.EVENT_SLAVEDATAS_CHANGED,n)},method:function(){return this.owner.first()}},prevRow:{label:justep.Message.getMessage(justep.Message.JUSTEP231010),icon:"icon-chevron-left",init:function(){var e=this,t=this.owner,n=function(){var n=t.getCount();e.setEnable(n>1&&t.getFirstRow()!==t.getCurrentRow(!0))};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n),this.owner.on(Data.EVENT_SLAVEDATAS_CHANGED,n)},method:function(){return this.owner.pre()}},nextRow:{label:justep.Message.getMessage(justep.Message.JUSTEP231011),icon:"icon-chevron-right",init:function(){var e=this,t=this.owner,n=function(){var n=t.getCount();e.setEnable(n>1&&t.getLastRow()!==t.getCurrentRow(!0))};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n),this.owner.on(Data.EVENT_SLAVEDATAS_CHANGED,n)},method:function(){return this.owner.next()}},lastRow:{label:justep.Message.getMessage(justep.Message.JUSTEP231087),icon:"icon-chevron-right",init:function(){var e=this,t=this.owner,n=function(){var n=t.getCount();e.setEnable(n>1&&t.getLastRow()!==t.getCurrentRow(!0))};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n),this.owner.on(Data.EVENT_SLAVEDATAS_CHANGED,n)},method:function(){return this.owner.last()}},loadPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231097),icon:"",argsDef:[{name:"pageIndex",displayName:justep.Message.getMessage(justep.Message.JUSTEP231061)}],method:function(e){var t=this.owner,n=isNaN(e.pagrIndex)||"number"!=typeof e.pagrIndex?1:e.pagrIndex;return t.loadPageData(n,{async:!0})}},firstPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231064),icon:"icon-chevron-left",init:function(){var e=this,t=this.owner,n=function(){e.setEnable(t.limit!=-1&&t.getOffset()>t.limit)};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_SLAVEDATAS_CHANGED,n)},method:function(e){return this.owner.loadPageData(1,{async:!0})}},prevPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231015),icon:"icon-chevron-left",init:function(){var e=this,t=this.owner,n=function(){e.setEnable(t.limit!=-1&&t.getOffset()>t.limit)};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_SLAVEDATAS_CHANGED,n)},method:function(e){var t=this.owner,n=t.getOffset()/t.limit-1;return t.loadPageData(n,{async:!0})}},nextPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231014),icon:"icon-chevron-right",init:function(){var e=this,t=this.owner,n=function(){e.setEnable(t.limit!=-1&&t.getOffset()<=t.getTotal())};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_SLAVEDATAS_CHANGED,n)},method:function(e){var t=this.owner,n=t.getOffset()/t.limit+1;return t.loadPageData(n,{async:!0})}},lastPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231065),icon:"icon-chevron-right",init:function(){var e=this,t=this.owner,n=function(){e.setEnable(t.limit!=-1&&t.getOffset()<=t.getTotal())};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_SLAVEDATAS_CHANGED,n)},method:function(e){var t=this.owner,n=t.getTotal()%t.limit,r=Math.round(t.getTotal()/t.limit-.5)+(n===0?0:1);return t.loadPageData(r,{async:!0})}},loadNextPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231012),icon:"icon-chevron-right",method:function(){return this.owner.loadNextPageData({async:!0})}},loadAllPage:{label:justep.Message.getMessage(justep.Message.JUSTEP231013),icon:"icon-chevron-right",method:function(){return this.owner.loadAllPageData({async:!0})}}}),Data.getColDef=function(e){if(e&&e.define){var t=e.define;return t.defCol}},Data.ExtendType=ExtendType,Data.registerExtendType=ExtendType.registerExtendType,Data.unregisterExtendType=ExtendType.unregisterExtendType,Data.getEditor=ExtendType.getEditor,Data.getExtendTypeClass=ExtendType.getExtendTypeClass,Data.getExtendTypeObject=ExtendType.getExtendTypeObject,Data}),define("$model/UI2/system/components/justep/data/baasData",["require","jquery","$UI/system/lib/justep","./data","$UI/system/lib/base/baas"],function(e){var t=e("jquery"),n=e("$UI/system/lib/justep"),r=e("./data"),i=e("$UI/system/lib/base/baas"),s=function(){this.filterList={},this.variables={}};s.prototype={clear:function(){for(var e in this.filterList)delete this.filterList[e];this.clearVars()},clearVars:function(){this.variables={}},getVar:function(e){return this.variables[e]},setVar:function(e,t){return this.variables[e]=t},setFilter:function(e,t){this.filterList[e]=t},getFilter:function(e){return this.filterList[e]},deleteFilter:function(e){delete this.filterList[e]},toString:function(){var e="";for(var t in this.filterList){var n=this.filterList[t];if(!n)continue;e+=e?" AND ("+n+")":"("+n+")"}return e}};var o=null;return o=r.extend({constructor:function(e,t){this.dataType="json",this.filters=new s,this.callParent(e,t),this.clz=o},buildFilter:function(){return this.filters.toString()},getFilter:function(e){return this.filters.getFilter(e)},setFilter:function(e,t){return this.filters.setFilter(e,t)},getQueryAction:function(){return this.queryAction},getNewAction:function(){return this.newAction},getSaveAction:function(){return this.saveAction},_initDefinition:function(){this.queryParam={},this.newParam={},this.saveParam={},this.queryAction=this.definition.queryAction||"queryAction",this.newAction=this.definition.newAction||"",this.saveAction=this.definition.saveAction||"saveAction",this.tableName=this.definition.tableName||"",this.url=this.definition.url||"/action",this.callParent()},_createSaveParam:function(e){this.saveParam.tables=[];var t=this.toJson({onlyChanged:!0,excludeCalculateCol:!0});this.saveParam.tables.push(t);if(!e){var n=this.slaveDatas.length;for(var i=0;i<n;i++){var s=this.slaveDatas[i];s&&this.saveParam.tables.push(s.toJson({onlyChanged:!0,excludeCalculateCol:!0}))}}var o={param:this.saveParam,source:this};this.fireEvent(r.EVENT_SAVEDATA_CREATEPARAM,o)},_rows2Json:function(e,t,n,r){var i=this.callParent.apply(this,arguments);return i.userdata.tableName=this.tableName,i},doSaveData:function(e){if(!this.getSaveAction()){var t=new n.Message(n.Message.JUSTEP231024,this.id);throw n.Error.create(t)}var r=e&&e.onlySelf||!1,s=!0;this._createSaveParam(r);var o=this;return i.sendRequest({url:this.url,action:this.getSaveAction(),params:this.saveParam,success:function(){o._saveSuccess(null,e)},error:function(t){o._saveError(t,e)}}),{success:s,async:!0}},applyUpdates:function(e,t){var n=t&&t.onlySelf||!1;if(!n){var r=this.slaveDatas.length;for(var i=0;i<r;i++){var s=this.slaveDatas[i];s&&s.applyUpdates(e,t)}}this.callParent(e,t)},_saveSuccess:function(e,t){var n={source:this,data:e};this.doSaveAfter(!0,t,n)},_saveError:function(e,n){var s={errorType:"server",errorNode:e,httpError:e.httpError,httpState:e.httpState,source:this},o=n&&n.onError&&t.isFunction(n.onError)||this.hasListener(r.EVENT_SAVEDATA_ERROR);o||i.showError(e),this.doSaveAfter(!1,n,s)},getDeleteParam:function(e){if(!e)return;var t=[],n=e.length;for(var i=0;i<n;i++){var s=e[i];r.STATE.NEW!=this.getRowState(s)&&(s=this._row2Json(s),s.userdata.recordState=r.STATE.DELETE,t.push(s))}return t.length>0?this._rows2Json(t,!0):null},doDirectDeleteData:function(e,n){var s=this.getDeleteParam(e);if(!s)return{success:!0,async:!1};var o=this;this.saveParam.tables=[s];if(s){var u=!0;return i.sendRequest({url:this.url,action:this.getSaveAction(),params:this.saveParam,success:function(){var t={source:o,deleteRows:e};o.doDeleteAfter(!0,n,t)},error:function(e){var s=n?n.onError:null,u={source:o,httpError:e.httpError,httpState:e.httpState,errorType:"server",errorNode:e},a=s&&t.isFunction(s)||o.hasListener(r.EVENT_DELETEDATA_ERROR);a||i.showError(e),o.doDeleteAfter(!1,n,u)}}),{success:u,async:!0}}return{success:!0,async:!1}},doRefreshData:function(e){return this._doRefreshData(this.getOffset(e?e.parent:null),this.limit,e)},_createRefreshParam:function(e,n,s,o){this.queryParam.tableName=this.tableName;if(this.master){var u=this.master.masterData,a=u.getCurrentRow();if(!a)return!1;if(u){var f=u.getRowID(a),l=this.defCols[this.master.relation].relation;this.queryParam.master={field:l,value:f}}else delete this.queryParam.master}if(this.isTree()){var c=this.defTreeOption.option;this.queryParam.tree={isDelayLoad:c.isDelayLoad,parentField:c.parentRelation,idField:this.idColumn},o.parent?this.queryParam.tree.parentValue=this.getRowID(o.parent):this.queryParam.tree.rootFilter=c.rootFilter}else delete this.queryParam.tree;var h=this.buildFilter();h?this.queryParam.filter=h:delete this.queryParam.filter;var p=!1;t.each(this.filters.variables,function(e,t){return p=!0,!1}),p?this.queryParam.variables=this.filters.variables:delete this.queryParam.variables,this.queryParam.offset=e,this.queryParam.limit=n,this.queryParam.columns=i.getDataColumns(this);var d=this.getOrderBys();d?this.queryParam.orderBy=d:delete this.queryParam.orderBy;var v={param:this.queryParam,source:this,offset:e,limit:n,options:o,append:!!s};return this.fireEvent(r.EVENT_REFRESHDATA_CREATEPARAM,v),!0},_doRefreshData:function(e,s,o){var u=null,a=null,f;o&&(t.isFunction(o)?a=o:(u=o.onError,a=o.onSuccess,f=o.onLoad));if(!this.getQueryAction()){var l=new n.Message(n.Message.JUSTEP231028,this.id);throw n.Error.create(l)}if(!this._createRefreshParam(e,s,o?o.append:!1,o))return!1;var c=this;return i.sendRequest({url:this.url,async:o.async,action:this.getQueryAction(),params:this.queryParam,success:function(n){var r=n;if(0===e){var i=r.userdata["sys.count"];c.setTotal(i,o?o.parent:null)}f&&t.isFunction(f)&&f({source:c,rows:r}),c.loadData(r,o?o.append:!1,o?o.parent:null);var s={source:c,rows:r};c.doRefreshAfter(!0,o,s)},error:function(e){var n={errorType:"server",errorNode:e.response,httpError:e.httpError,httpState:e.httpState,source:c},s=u&&t.isFunction(u)||c.hasListener(r.EVENT_REFRESHDATA_ERROR);s||i.showError(e),c.doRefreshAfter(!1,o,n)}}),{success:!0,async:!0}}}),o}),define("$model/UI2/system/components/justep/data/restData",["require","jquery","$UI/system/lib/justep","./data"],function(require){var $=require("jquery"),justep=require("$UI/system/lib/justep"),Data=require("./data"),Filter=function(){this.filterList={},this.variables={}};Filter.prototype={clear:function(){for(var e in this.filterList)delete this.filterList[e];this.clearVars()},clearVars:function(){this.variables={}},getVar:function(e){return this.variables["__"+e]},setVar:function(e,t){return this.variables["__"+e]=t},setFilter:function(e,t){this.filterList[e]=t},getFilter:function(e){return this.filterList[e]},deleteFilter:function(e){delete this.filterList[e]}};var FilterContext=function(e,t,n){$.extend(this,{$model:e,$data:t},n),this.result=[]},filterFNs=["eq","neq","gt","lt","gte","lte","like","ilike","is","inn","not","isNull","isNotNull"];$.each(filterFNs,function(e,t){FilterContext.prototype[t]=function(e,n,r){if("isNull"!==t&&"isNotNull"!==t||!1!==n){if(n===undefined||n===null||n===""||typeof n=="number"&&isNaN(n)||n instanceof Data.ErrorValue){if("is"!==t&&"isNull"!==t&&"isNotNull"!==t)return this;n=null}if(this.$data){var i=this.$data.defCols[e];if(i){var s=i.define;s&&s!=e&&(e=s)}if(i&&i.type&&n&&"string"==typeof n){var o=i.type.toLowerCase();o==="time"?n=justep.Date.fromString(n,justep.Date.STANDART_TIME_FORMAT):o==="datetime"&&(n=justep.Date.fromString(n,justep.Date.STANDART_FORMAT))}i&&i.type&&n instanceof Date&&i.type.toLowerCase()==="date"&&(n=justep.Date.toString(n,justep.Date.STANDART_FORMAT_SHOT)),n instanceof Date&&(n=n.toISOString());if(this.$data.join){var u=i.tableAlias||i.table||this.$data.tableName;u&&(e=u+"."+e)}}var a=t;return t=="like"||t=="ilike"?n?(n+"").indexOf("*")<0&&(n="*"+n+"*"):n="*":t=="isNull"?(n=null,a="is"):t=="isNotNull"&&(n=null,a="not.is"),this.result.push(justep.String.format("{3}{0}={1}.{2}",e,"inn"!==a?a:"in",$.isArray(n)?n.join(","):n,typeof r=="string"&&"or"===r.toLowerCase()?"or.":"")),this}return this}});var _getErrMsg=function(e){return _getPgsqlErrMsg(e)||_getMysqlErrMsg(e)},_getPgsqlErrMsg=function(e){var t=e,n="duplicate key value",r=")=(",i=") already exists.",s="value too long for type",o="For input string: ";if(t){var u;if(t.indexOf(n)>-1){u=t.indexOf(r);if(u>-1)return t.substring(u+r.length).replace(i," 是已经存在的值")}else{if(t.indexOf(s)>-1)return"数据长度超出范围("+t+")";if(t.indexOf(o)>-1){u=t.indexOf(o);if(u>-1)return t.substring(u+o.length)+" 值无法存储，可能数据长度超出范围"}}}},_getMysqlErrMsg=function(e){var t=e,n=[{str1:"Duplicate entry ",str2:" for key",info:" 是已经存在的值"},{str1:"Data truncation: Data too long for column ",str2:" at row",info:"数据长度超出范围"},{str1:"Data truncation: Out of range value for column ",str2:" at row",info:"数据长度超出范围"}];if(t)for(var r=0;r<n.length;r++){var i=n[r];if(t.indexOf(i.str1)===0){var s=t.indexOf(i.str2);if(s>-1)return t.substring(i.str1.length,s)+i.info}}},showError=function(e){e=e||{},justep.Util.hint(justep.String.format("错误编码:{0}<br>错误信息:{1}{2}{3}{4}",e.code||"无",e.message||"未知错误",e.hint?"<br>"+e.hint:"",e.details?"<br>"+e.details:"",e.exception?"<br>"+(_getErrMsg(e.exception)||e.exception):""),{type:"danger",delay:8e3})},RestData;return RestData=Data.extend({constructor:function(e,t){this.dataType="json",this.filters=new Filter,this.callParent(e,t),this.clz=RestData,this.directDeleteMode=!0,this.useHeaderOffset=!1},buildUrl:function(e){var t=justep.Util.getCookie("WEBAPP-NAME-PREFIX"),n=t?"/"+t+"dbrest":this.url;n=n+"/"+this.tableName;if(e){n+="?";if($.isArray(e))for(var r=0;r<e.length;r++)n+=(r===0?"":"&")+e[r];else n+=e}return n},getFilter:function(e){return this.filters.getFilter(e)},setFilter:function(e,t){return this.filters.setFilter(e,t)},_initDefinition:function(e){this.className=this.definition.className||"",this.tableName=this.definition.tableName||"",this.url=this.definition.url||"/dbrest",this.autoMode=this.definition.autoMode,this.join=this.definition.join,this.defSlaves=this.definition.defSlaves||[],this._existIDContext(e)||("load"===this.autoMode?(this.autoLoad=!0,this.autoNew=!1):"new"===this.autoMode&&(this.autoLoad=!1,this.autoNew=!0)),this.callParent();if(this.master&&this.master.relation){var t=this.defCols[this.master.relation];t&&!t.readonly&&(t.readonly="true")}if($.isArray(this.join)){var n={},r=this;$.each(this.join,function(e,t){var i=t.rightTable;if(!n[i])n[i]=1;else{t.rightTableAlias=i+n[i],n[i]=n[i]+1;var s=t.columns;$.isArray(s)&&$.each(s,function(e,n){var i=r.defCols[n.name];i&&(i.tableAlias=t.rightTableAlias)})}})}},_init:function(e,t){this.callParent(e,t)},saveAllData:function(e){e=e||{},e.allData=!0,e.onlySelf=!0,this.saveData(e)},doSaveData:function(e){var t=!1;e=e||{};var n=!!e.allData,r,i=this;if(n){r=justep.String.format("{0}={1}","pk",this.idColumn);var s=[];this.eachByPeek(function(e){var t=this.getRowState(e.row);(Data.STATE.NEW==t||Data.STATE.EDIT==t)&&s.push(this.processSaveRow(e.row.toJson({format:"simple",excludeCalculateCol:!0})))},this),$.ajax({type:"PUT",dataType:"json",contentType:"application/json",processData:!1,url:this.buildUrl(r),data:JSON.stringify(s),complete:function(t,n){t.status>=200&&t.status<300?i._saveSuccess(null,e):i._saveError(t,e)}}),t=!0}else{var o=e.row||this.getCurrentRow(!0);if(o){var u=o.data.getRowState(o);if(Data.STATE.NEW==u||Data.STATE.EDIT==u||this.isSlaveChanged()){var a=Data.STATE.NEW===u,f=a?"POST":"PUT";r=a?null:justep.String.format("{0}=eq.{1}",this.idColumn,o.getID()),$.ajax({type:f,dataType:"json",contentType:"application/json",processData:!1,url:this.buildUrl(r),data:JSON.stringify(this.processSaveRow(o.toJson({format:"simple",excludeCalculateCol:!0}))),complete:function(t,n){t.status>=200&&t.status<300?i._saveSuccess(null,e):i._saveError(t,e)}}),t=!0}}}return{success:t,async:!0}},add:function(e,t,n,r){for(var i in this.defCols){var s=this.defCols[i].define,o=this.defCols[i].type;if(o==="DateTime"){var u=e[i]||e[s];if(u instanceof Date||typeof u=="string")try{u=u instanceof Date?u:new Date(u),e[i]=u instanceof Date?justep.Date.toString(u,"yyyy-MM-ddThh:mm:ss.fff"):""}catch(a){}}!e.hasOwnProperty(i)&&s&&(e[i]=e[s])}return this.callParent(e,t,n,r)},processSaveRow:function(e,t){if(e){for(var n in e){var r=this.defCols[n];r&&r.table&&r.table!==this.tableName?delete e[n]:r&&r.define&&n!=r.define&&(e[r.define]=e[n],delete e[n])}if(!t){var i=this.processSlaveSaveRow(e);$.isArray(i)&&i.length>0&&$.each(i,function(t,n){e[n.key]=n.rows})}}return e},processSlaveSaveRow:function(e){var t=this.slaveDatas.length;if(t>0){var n=[],r=e[this.idColumn],i=function(e){var t=e.data;r===e.row.val(t.master.relation)&&f.push(t.processSaveRow(e.row.toJson({format:"simple",excludeCalculateCol:!0})))};for(var s=0;s<t;s++){var o=this.slaveDatas[s];if(o){var u=o.defCols[o.idColumn],a=o.tableName+"."+(u.define||o.idColumn),f=[];o.eachAllByPeek(i),f.length>0&&n.push({key:a,rows:f})}}return n}},_row2Json:function(e,t,n,r){var i=this.callParent(e,t,n,r);i&&r&&delete i.userdata;for(var s in this.defCols){var o=this.defCols[s];if(o&&o.type==="DateTime"&&i.hasOwnProperty(s)){var u=i[s],a=this.convert(u,o.type);i[s]=a instanceof Date?a.toISOString():a}}return i},_saveSuccess:function(e,t){var n={source:this,data:e};this.doSaveAfter(!0,t,n)},_saveError:function(e,t){var n={errorType:"server",errorNode:e.responseJSON,httpState:e.status,source:this},r=t&&t.onError&&$.isFunction(t.onError)||this.hasListener(Data.EVENT_SAVEDATA_ERROR);r||showError(e.responseJSON),this.doSaveAfter(!1,t,n)},getDeleteParam:function(e){if(!e)return;var t=[],n,r=this.defCols[this.idColumn],i=r&&r.define||this.idColumn,s=e.length;for(n=0;n<s;n++){var o=e[n];Data.STATE.NEW!=this.getRowState(o)&&t.push(o.getID())}var u=[];s=this.defSlaves.length;if(s>0)for(n=0;n<s;n++){var a=this.defSlaves[n];a&&a.table&&a.field&&u.push(i+"."+a.table+"."+a.field)}var f=[];return t.length>0&&f.push(i+"=in."+t.join(",")),u.length>0&&f.push("cascade="+u.join(",")),f.length>0?f.join("&"):null},deleteAllData:function(e){e=e||{};var t=this.confirmDelete;e&&undefined!==e.confirm&&(t=e.confirm);var n=this,r=function(){$.ajax({type:"DELETE",dataType:"json",url:n.buildUrl(),success:function(){n._clear()},error:function(t){var n=e?e.onError:null,r=n&&$.isFunction(n);r||showError(t.responseJSON)}})};t?this._confirm(e.confirmText||this.confirmDeleteText,r,null,!1):r()},doDirectDeleteData:function(e,t){var n=this.getDeleteParam(e);if(!n)return{success:!0,async:!1};var r=this;if(n){var i=!0;return $.ajax({type:"DELETE",dataType:"json",url:this.buildUrl(n),success:function(){var n={source:r,deleteRows:e};r.doDeleteAfter(!0,t,n)},error:function(e){var n=t?t.onError:null,i={errorType:"server",errorNode:e.responseJSON,httpState:e.status,source:r},s=n&&$.isFunction(n)||r.hasListener(Data.EVENT_DELETEDATA_ERROR);s||showError(e.responseJSON),r.doDeleteAfter(!1,t,i)}}),{success:i,async:!0}}return{success:!0,async:!1}},doRefreshData:function(e){return this._doRefreshData(this.getOffset(e?e.parent:null),this.limit,e)},getOrderBys:function(){var e=[];for(var t=0;t<this.orderBys.length;t++){var n=this.orderBys[t];e.push(justep.String.format("{0}.{1}",n.relation,0===n.type?"desc":"asc"))}return e.length>0?"order="+e.join(","):null},_existIDContext:function(e){var t=this.className+".id";return this._existParamContext(e,t)},_existMasterIDContext:function(e){var t=this.className+".master.id";return this._existParamContext(e,t)},_existMasterRelationContext:function(e){var t=this.className+".master.column";return this._existParamContext(e,t)},_createRefreshParam:function(e,t,n,r){var i={};if(this.master){var s=this.master.masterData,o=s.getCurrentRow();if(!o)return!1;if(s){var u=s.getRowID(o),a=this.master.relation;this.setFilter("_sys_master_id_filter_",justep.String.format("eq('{0}','{1}')",a,u))}}if(this.isTree()){var f=this.defTreeOption.option,l=null;r.parent&&(i.tree.parentValue=this.getRowID(r.parent)),this.setFilter("_sys_parent_filter_",justep.String.format("{0}('{1}','{2}')",l!==null?"eq":"is",f.parent,l))}else{var c=this.getModel(),h=this.className+".id";if(this._existIDContext()){var p=this.defCols[this.idColumn],d=p&&p.define||this.idColumn;this.setFilter("_sys_id_filter_",justep.String.format("eq('{0}','{1}')",d,c.params[h]))}if(this._existMasterIDContext()&&this._existMasterRelationContext()){var v=c.params[this.concept+".master.column"],m=c.params[this.concept+".master.id"];v&&this.setFilter("_sys_master_id_filter_",justep.String.format("eq('{0}','{1}')",v,m))}}var g=this.buildFilter();g&&(i.filter=g),i.offset=e,i.limit=t,i.columns=this.getSelectColumns();if(this.join){var y=[];$.each(this.join,function(e,t){var n=t.leftTable,r=t.rightTable,i=t.rightTableAlias,s=t.on[0];y.push(justep.String.format("{0}.{1}.{2}.{3}.{4}",n,s.leftField,s.fn,r+(i?"|"+i:""),s.rightField))}),i.join=y.join()}if(0===e&&!$.isEmptyObject(this.defAggCols)){var b=[];for(var w in this.defAggCols)b.push(this.defAggCols[w]);i.aggColumns=b.join()}var E=this.getOrderBys();return E&&(i.orderBy=E),i},hasJoinCol:function(){if($.isArray(this.join)&&this.join.length>0)for(var e=0;e<this.join.length;e++){var t=this.join[e].columns;if($.isArray(t)&&t.length>0)return!0}return!1},getSelectColumns:function(){var e,t,n;if(!this.hasJoinCol()){e=[];for(t in this.defCols)this.isCalculateCol(this.defCols[t])||(n=this.defCols[t].define,n==t?e.push(n):e.push(justep.String.format('{0} as "{1}"',n,t)));return e.join(this.delim)}e=[];for(t in this.defCols)if(!this.isCalculateCol(this.defCols[t])){var r=this.defCols[t].tableAlias||this.defCols[t].table;r=r||this.tableName,n=this.defCols[t].define,e.push(justep.String.format('{0}.{1} as "{2}"',r,n,t))}return e.join(this.delim)},_getQueryParam:function(e){var t=[];return this.useHeaderOffset||($.isNumeric(e.limit)&&t.push("limit="+e.limit),$.isNumeric(e.offset)&&t.push("offset="+e.offset)),e.columns&&t.push("select="+e.columns),e.join&&t.push("join="+e.join),e.orderBy&&t.push(e.orderBy),$.isArray(e.filter)&&$.each(e.filter,function(e,n){t.push(n)}),t.length>0?t:null},_getQueryAggregateParam:function(e){var t=[];return e.aggColumns&&t.push("select="+e.aggColumns),$.isArray(e.filter)&&$.each(e.filter,function(e,n){t.push(n)}),t.length>0?t:null},_processFilter:function(filter,variables){var ctx=new FilterContext(this.getModel(),this,variables);try{with(ctx)eval("("+filter+")")}catch(e){throw justep.Error.create("过滤表达式["+filter+"]处理时存在问题,详细信息:"+(e.message||""))}return $.isArray(ctx.result)&&ctx.result.length>0?ctx.result:null},buildHaving:function(){var e=[],t=this.defAgg.havings;for(var n in t){var r=t[n];if(!r)continue;var i=this._processFilter(r,null);$.isArray(i)&&(e=e.concat(i))}return e.length>0?e:null},buildFilter:function(){var e=[],t=this.filters.filterList,n=this.filters.variables;for(var r in t){var i=t[r];if(!i)continue;var s=this._processFilter(i,n);$.isArray(s)&&(e=e.concat(s))}return e.length>0?e:null},_doRefreshData:function(e,t,n){var r=null,i=null,s;n&&($.isFunction(n)?i=n:(r=n.onError,i=n.onSuccess,s=n.onLoad));var o=this._createRefreshParam(e,t,n?n.append:!1,n);if(!o)return!1;var u=this._getQueryParam(o),a={};this.useHeaderOffset&&$.isNumeric(o.limit)&&o.limit>0&&(a["Range-Unit"]="items",a.Range=justep.String.format("{0}-{1}",o.offset,o.offset+o.limit-1));var f=this;return $.ajax({type:"GET",dataType:"json",headers:a,url:this.buildUrl(u),success:function(t,r,i){var o=t;if(0===e){var u=i.getResponseHeader("Content-Range");if(u){var a=u.lastIndexOf("/");a>-1&&(u=u.substring(a+1)),u=parseInt(u,10),f.setTotal(u,n?n.parent:null)}}s&&$.isFunction(s)&&s({source:f,rows:o}),f.loadData(o,n?n.append:!1,n?n.parent:null,undefined);var l={source:f,rows:o};f.doRefreshAfter(!0,n,l)},error:function(e){var t={errorType:"server",errorNode:e.responseJSON,httpState:e.status,source:f},i=r&&$.isFunction(r)||f.hasListener(Data.EVENT_REFRESHDATA_ERROR);i||showError(e.responseJSON),f.doRefreshAfter(!1,n,t)}}),0===e&&!$.isEmptyObject(this.defAggCols)&&this.refreshAggregateValue(n?n.parent:null),{success:!0,async:!0}},refreshAggregateValue:function(e){var t=this._createRefreshParam(0,20,!1,{parent:e});if(!t)return!1;var n=this._getQueryAggregateParam(t),r=this;$.ajax({type:"GET",dataType:"json",url:this.buildUrl(n),success:function(t,n,i){var s=$.isArray(t)?t.length>0?t[0]:{}:t,o;for(var u in r.defAggCols)o=r.defAggCols[u],s.hasOwnProperty(o)&&r.setUserData(u,s[o],e)},error:function(e){showError(e.responseJSON)}})},_newDataDefaultvalue:function(e){if(!e||e.length<=0)e=[{}];var t=this.idColumn,n=this.defCols[t];n&&$.each(e,function(e,r){r&&!r.hasOwnProperty(t)&&"String"===n.type&&(r[t]=Data.UUID())});var r=this.getModel(),i=this._existMasterIDContext()&&this._existMasterRelationContext();if(i||this.master&&this.master.masterData){var s,o;if(i)s=r.params[this.concept+".master.column"],o=r.params[this.concept+".master.id"];else{var u=this.master.masterData,a=u.getCurrentRow();o=u.getRowID(a),s=this.master.relation}s&&$.each(e,function(e,t){t[s]=o})}return e},doNewData:function(e,t){return e=this._newDataDefaultvalue(e),this.callParent(e,t)}}),justep.Component.addOperations(RestData,{saveAll:{label:justep.Message.getMessage(justep.Message.JUSTEP231152),icon:"glyphicon glyphicon-floppy-disk",init:function(){var e=this,t=this.owner,n=function(){e.setEnable(!t.getReadonly()&&t.isChanged())};this.owner.on(Data.EVENT_DATA_CHANGE,n),this.owner.on(Data.EVENT_SAVE_COMMIT,n),this.owner.on(Data.EVENT_INDEX_CHANGED,n)},method:function(e){return this.owner.saveAllData()}},setFilter:{label:"设置过滤",argsDef:[{name:"filters",displayName:"过滤"},{name:"name",displayName:"过滤名称"}],method:function(e){var t=e.filters,n="";if($.isArray(t)&&t.length>0){var r=[];$.each(t,function(e,t){if(t&&t.name&&t.op){var n=t.value;n===undefined||n===null||n===""||typeof n=="number"&&isNaN(n)||n instanceof Data.ErrorValue?n=null:n instanceof Date?n=justep.String.format('new Date("{0}")',n.toISOString()):typeof n=="string"&&(n=justep.String.format('"{0}"',n.replace(/"/g,'\\"'))),r.push(justep.String.format('{0}("{1}",{2}{3})',t.op,t.name,n,"or"===t.kind?',"or"':""))}}),n=r.join(".")}return this.owner.setFilter(e.name||"__op_filter__",n)}},clearFilter:{label:"清除所有过滤",method:function(e){return this.owner.filters.clear()}},setOrderBy:{label:"设置排序",argsDef:[{name:"col",displayName:"列"},{name:"type",displayName:"排序方式"}],method:function(e){if(e.col)return this.owner.setOrderBy(e.col,e.type==="desc"?0:e.type==="asc"?1:null)}},clearOrderBy:{label:"清除所有排序",method:function(e){return this.owner.clearOrderBy()}}}),RestData}),define("$model/UI2/system/components/justep/data/aggregateData",["require","jquery","$UI/system/lib/justep","./data","./restData"],function(require){var $=require("jquery"),justep=require("$UI/system/lib/justep"),Data=require("./data"),RestData=require("./restData"),Filter=function(){this.filterList={},this.variables={}};Filter.prototype={clear:function(){for(var e in this.filterList)delete this.filterList[e];this.clearVars()},clearVars:function(){this.variables={}},getVar:function(e){return this.variables["__"+e]},setVar:function(e,t){return this.variables["__"+e]=t},set:function(e,t){this.filterList[e]=t},get:function(e){return this.filterList[e]},remove:function(e){delete this.filterList[e]}};var FilterContext=function(e,t,n){$.extend(this,{$model:e,$data:t},n),this.result=[]},filterFNs=["eq","neq","gt","lt","gte","lte","like","ilike","not"];$.each(filterFNs,function(e,t){FilterContext.prototype[t]=function(e,n){if(t=="like"||t=="ilike")n?(n+"").indexOf("*")<0&&(n="*"+n+"*"):n="*";return this.result.push(justep.String.format("{0}={1}.{2}",e,"inn"!==t?t:"in",$.isArray(n)?n.join(","):n)),this}});var showError=function(e){e=e||{},justep.Util.hint(justep.String.format("错误编码:{0}<br>错误信息:{1}{2}{3}{4}",e.code||"无",e.message||"未知错误",e.hint?"<br>"+e.hint:"",e.details?"<br>"+e.details:"",e.exception?"<br>"+e.exception:""),{type:"danger",delay:8e3})},AggData;return AggData=RestData.extend({constructor:function(e,t){this.dataType="json",this.havings=new Filter,this.groupBy=[],this.callParent(e,t),this.clz=AggData},getHaving:function(e){return this.havings.get(e)},setHaving:function(e,t){return this.havings.set(e,t)},_initDefinition:function(e){this.callParent(),this.autoMode="",this.by=this.definition.by,this.definition.groupBy&&(this.groupBy=this.definition.groupBy);var t=this.definition.havings;for(var n in t)this.setHaving(n,t[n])},_initDefCols:function(){this.callParent(),$.each(this.defCols,function(e,t){t.fn&&t.field&&(t.aggDef=justep.String.format("{0}({1})",t.fn,t.field))}),this.idColumn="idCol",this.defCols[this.idColumn]={type:"String",label:"ID列"}},_init:function(e,t){this.callParent(e,t)},_createReadonly:function(){this.definition.readonly="true",this.callParent()},saveData:function(e){showError({message:"不支持保存"})},newData:function(e){showError({message:"不支持新增"})},deleteData:function(e){showError({message:"不支持删除"})},_row2Json:function(e,t,n,r){var i=this.callParent(e,t,n,r);return i&&delete i.userdata,i},doRefreshData:function(e){this.byData=Data.$(this.getModel(),this.by),this.byData instanceof RestData&&(this.className=this.byData.className,this.url=this.byData.url);if(this.className&&this.url)return this._doRefreshData(this.getOffset(e?e.parent:null),this.limit,e);showError({message:"缺少url或者className定义"})},_getSelectCol:function(){var e=[],t=this.groupBy;return $.each(this.defCols,function(n,r){r.aggDef?e.push(r.aggDef):t.indexOf(r.field)>-1&&e.push(r.field)}),e.join()},_getGroupBy:function(){return this.groupBy.join()},getOrderBys:function(){var e=[];for(var t=0;t<this.orderBys.length;t++){var n=this.orderBys[t],r=n.relation,i=this.defCols[r];i&&i.aggDef&&(r=i.aggDef),e.push(justep.String.format("{0}.{1}",r,0===n.type?"desc":"asc"))}return e.length>0?"order="+e.join(","):null},_createRefreshParam:function(e,t,n,r){var i={},s=this.buildFilter();s&&(i.filter=s);var o=this.buildHaving();o&&(i.having=o),i.columns=this._getSelectCol(),i.groupBy=this._getGroupBy();var u=this.getOrderBys();return u&&(i.orderBy=u),i.offset=e,i.limit=t,i},_getQueryParam:function(e){var t=[];return $.isNumeric(e.limit)&&t.push("limit="+e.limit),$.isNumeric(e.offset)&&t.push("offset="+e.offset),e.columns&&t.push("select="+e.columns),e.orderBy&&t.push(e.orderBy),$.isArray(e.filter)&&$.each(e.filter,function(e,n){t.push(n)}),$.isArray(e.having)&&$.each(e.having,function(e,n){t.push("having::"+n)}),e.groupBy&&t.push("groupby="+e.groupBy),t.length>0?t:null},_processHaving:function(filter,variables){var ctx=new FilterContext(this.getModel(),this,variables);try{with(ctx)eval("("+filter+")")}catch(e){throw justep.Error.create("统计过滤表达式["+filter+"]处理时存在问题,详细信息:"+(e.message||""))}return $.isArray(ctx.result)&&ctx.result.length>0?ctx.result:null},buildHaving:function(){var e=[],t=this.havings.filterList,n=this.havings.variables;for(var r in t){var i=t[r];if(!i)continue;var s=this._processHaving(i,n);$.isArray(s)&&(e=e.concat(s))}return e.length>0?e:null},buildFilter:function(){return this.byData?this.byData.buildFilter():this.callParent()},_processRow:function(e){if(e){var t=this.groupBy;$.each(this.defCols,function(n,r){r.aggDef?e[n]=e[r.aggDef]:t.indexOf(r.field)>-1&&(e[n]=e[r.field])})}return e},add:function(e,t,n,r){return e=this._processRow(e),this.callParent(e,t,n,r)},_doRefreshData:function(e,t,n){var r=null,i=null,s;n&&($.isFunction(n)?i=n:(r=n.onError,i=n.onSuccess,s=n.onLoad));var o=this._createRefreshParam(e,t,n?n.append:!1,n);if(!o)return!1;var u=this._getQueryParam(o),a={},f=this;return $.ajax({type:"GET",dataType:"json",headers:a,url:this.buildUrl(u),success:function(t,r,i){var o=t;if(0===e){var u=i.getResponseHeader("Content-Range");if(u){var a=u.lastIndexOf("/");a>-1&&(u=u.substring(a+1)),u=parseInt(u,10),f.setTotal(u,n?n.parent:null)}}s&&$.isFunction(s)&&s({source:f,rows:o}),f.loadData(o,n?n.append:!1,n?n.parent:null);var l={source:f,rows:o};f.doRefreshAfter(!0,n,l)},error:function(e){var t={errorType:"server",errorNode:e.responseJSON,httpState:e.status,source:f},i=r&&$.isFunction(r)||f.hasListener(Data.EVENT_REFRESHDATA_ERROR);i||showError(e.responseJSON),f.doRefreshAfter(!1,n,t)}}),{success:!0,async:!0}}}),AggData}),define("$model/UI2/system/components/justep/model/model.config",["require"],function(e){return{properties:{},events:["onModelConstruct","onModelConstructing","onModelConstructDone","onLoad","onParamsReceive","onLoaded","onunLoad","onActive","onInactive"],binds:{}}}),define("$model/UI2/system/components/justep/model/model",["require","jquery","$UI/system/lib/justep","./model.config","$UI/system/resources/system.res"],function(e){var t=e("jquery"),n=e("$UI/system/lib/justep"),r=e.normalizeName("./model"),i=e("./model.config");e("$UI/system/resources/system.res");var s=n.ViewComponent.extend({buildTemplate:function(e){var t=new n.Message(n.Message.JUSTEP230073,r);throw n.Error.create(t)},getConfig:function(){return i},init:function(e,t){this.callParent(e,t),this.getModel().on(n.ModelBase.MODEL_CONSTRUCT_EVENT,this._fireEvent.bind(this,n.ModelBase.MODEL_CONSTRUCT_EVENT)),this.getModel().on(n.ModelBase.MODEL_CONSTRUCT_DONE_EVENT,this._fireEvent.bind(this,n.ModelBase.MODEL_CONSTRUCT_DONE_EVENT)),this.getModel().on(n.ModelBase.LOAD_EVENT,this._fireEvent.bind(this,n.ModelBase.LOAD_EVENT)),this.getModel().on(n.ModelBase.PARAMS_RECEIVE_EVENT,this._fireEvent.bind(this,n.ModelBase.PARAMS_RECEIVE_EVENT)),this.getModel().on(n.ModelBase.LOADED_EVENT,this._fireEvent.bind(this,n.ModelBase.LOADED_EVENT)),this.getModel().on(n.ModelBase.UNLOAD_EVENT,this._fireEvent.bind(this,n.ModelBase.UNLOAD_EVENT)),this.getModel().on(n.ModelBase.ACTIVE_EVENT,this._fireEvent.bind(this,n.ModelBase.ACTIVE_EVENT)),this.getModel().on(n.ModelBase.INACTIVE_EVENT,this._fireEvent.bind(this,n.ModelBase.INACTIVE_EVENT))},_fireEvent:function(e,t){var n=t.source;t.source=this,this.fireEvent(e,t),t.source=n}});return n.Component.register(r,s),s}),define("$model/UI2/system/components/justep/window/window",["require","$UI/system/lib/justep"],function(e){var t=e("$UI/system/lib/justep"),n=e.normalizeName("./window"),r=t.ViewComponent.extend({getConfig:function(){return{}},constructor:function(e){this.callParent(e),this.backgroundImage="",this.title=""},init:function(e,t){this.callParent(e,t);var n=this.buildSrc(this.$domNode.attr("backgroundImage"));n&&this.setBackgroundImage(n),this.title=this.$domNode.attr("title"),this.$domNode.removeAttr("title"),this.initTitle()},initTitle:function(){if(this.title){this._titleExpr=t.Bind.observable(new t.Express(this.title));var e=this;t.Bind.computed(function(){var n=e._titleExpr.get();if(n instanceof t.Express){var r=t.Express.eval(n,this,{$model:this});this.setTitle(r||"")}},this.getModel())}},buildSrc:function(t){return t&&t.indexOf("$UI")!=-1&&(t=e.toUrl(t)),t||""},propertyChangedHandler:function(e,n,r){switch(e){case"backgroundImage":this.setBackgroundImage(this.buildSrc(r));break;case"title":r&&this._titleExpr.set(new t.Express(r))}},setBackgroundImage:function(e){this.$domNode.css("background-image",e?"url("+e+")":""),this.$domNode.css("backgroundSize","cover"),this.$domNode.css("width","100%"),t.Browser.isMobile&&this.$domNode.css("height","100%")},close:function(){var e=this.getModel();e.owner.close()},send:function(e){var t=this.getModel();t.owner.send(e)}});return t.Component.addOperations(r,{close:{label:t.Message.getMessage(t.Message.JUSTEP230096),icon:"icon-chevron-left",method:function(e){this.owner.close()}}}),t.Component.register(n,r),r}),function(e){if(typeof exports=="object"&&typeof module!="undefined")module.exports=e();else if(typeof define=="function"&&define.amd)define("$model/UI2/system/lib/base/store",[],e);else{var t;typeof window!="undefined"?t=window:typeof global!="undefined"?t=global:typeof self!="undefined"?t=self:t=this,t.store=e()}}(function(){var e,t,n;return function r(e,t,n){function i(o,u){if(!t[o]){if(!e[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(s)return s(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=t[o]={exports:{}};e[o][0].call(l.exports,function(t){var n=e[o][1][t];return i(n?n:t)},l,l.exports,r,e,t,n)}return t[o].exports}var s=typeof require=="function"&&require;for(var o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,t,n){(function(e){t.exports=function(){function t(){try{if(o in i&&i[o]){var e="test",t=i[o];return t.setItem(e,"testValue"),t.removeItem(e),!0}return!1}catch(n){return!1}}var n,r={},i="undefined"!=typeof window?window:e,s=i.document,o="localStorage",u="script";if(r.disabled=!1,r.version="1.3.20",r.set=function(e,t){},r.get=function(e,t){},r.has=function(e){return void 0!==r.get(e)},r.remove=function(e){},r.clear=function(){},r.transact=function(e,t,n){null==n&&(n=t,t=null),null==t&&(t={});var i=r.get(e,t);n(i),r.set(e,i)},r.getAll=function(){var e={};return r.forEach(function(t,n){e[t]=n}),e},r.forEach=function(){},r.serialize=function(e){return JSON.stringify(e)},r.deserialize=function(e){if("string"==typeof e)try{return JSON.parse(e)}catch(t){return e||void 0}},t())n=i[o],r.set=function(e,t){return void 0===t?r.remove(e):(n.setItem(e,r.serialize(t)),t)},r.get=function(e,t){var i=r.deserialize(n.getItem(e));return void 0===i?t:i},r.remove=function(e){n.removeItem(e)},r.clear=function(){n.clear()},r.forEach=function(e){for(var t=0;t<n.length;t++){var i=n.key(t);e(i,r.get(i))}};else if(s&&s.documentElement.addBehavior){var a,f;try{f=new ActiveXObject("htmlfile"),f.open(),f.write("<"+u+">document.w=window</"+u+'><iframe src="/favicon.ico"></iframe>'),f.close(),a=f.w.frames[0].document,n=a.createElement("div")}catch(l){n=s.createElement("div"),a=s.body}var c=function(e){return function(){var t=Array.prototype.slice.call(arguments,0);t.unshift(n),a.appendChild(n),n.addBehavior("#default#userData"),n.load(o);var i=e.apply(r,t);return a.removeChild(n),i}},h=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g"),p=function(e){return e.replace(/^d/,"___$&").replace(h,"___")};r.set=c(function(e,t,n){return t=p(t),void 0===n?r.remove(t):(e.setAttribute(t,r.serialize(n)),e.save(o),n)}),r.get=c(function(e,t,n){t=p(t);var i=r.deserialize(e.getAttribute(t));return void 0===i?n:i}),r.remove=c(function(e,t){t=p(t),e.removeAttribute(t),e.save(o)}),r.clear=c(function(e){var t=e.XMLDocument.documentElement.attributes;e.load(o);for(var n=t.length-1;n>=0;n--)e.removeAttribute(t[n].name);e.save(o)}),r.forEach=c(function(e,t){for(var n,i=e.XMLDocument.documentElement.attributes,s=0;n=i[s];++s)t(n.name,r.deserialize(e.getAttribute(n.name)))})}try{var d="__storejs__";r.set(d,d),r.get(d)!=d&&(r.disabled=!0),r.remove(d)}catch(l){r.disabled=!0}return r.enabled=!r.disabled,r}()}).call(this,typeof global!="undefined"?global:typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{}]},{},[1])(1)}),define("$model/UI2/system/components/justep/versionChecker/versionChecker",["require","jquery","$UI/system/lib/base/browser","$UI/system/components/justep/messageDialog/messageDialog","$UI/system/lib/base/store","cordova!cordova-plugin-app-version","cordova!cordova-plugin-inappbrowser","cordova!cordova-plugin-x-toast","cordova!cordova-plugin-spinner-dialog"],function(e){var t=e("jquery"),n=e("$UI/system/lib/base/browser"),r=e("$UI/system/components/justep/messageDialog/messageDialog"),i=e("$UI/system/lib/base/store");e("cordova!cordova-plugin-app-version"),e("cordova!cordova-plugin-inappbrowser"),e("cordova!cordova-plugin-x-toast"),e("cordova!cordova-plugin-spinner-dialog");var s=t("body").find(".window").get(0),o=function(){this.env="browser",n.isX5App&&(n.isAndroid&&(this.env="androidApp"),n.isIOS&&(this.env="iosApp")),this.versionMsg=new r({parentNode:s});var e=this.versionMsg.$domNode;e.find(".Yes").text("更新"),e.find(".No").text("忽略"),this.versionMsg.on("onYes",function(e){this.download()},this),this.versionMsg.on("onNo",function(e){this.ignore()},this),this.resourceInfo=window.__justep.versionInfo.resourceInfo,this.appInfo=window.__justep.versionInfo.appInfo};return o.prototype.check=function(){this.resourceInfo&&(this.resourceInfo.resourceUpdateMode=="md5"?this.checkResourceMd5():this.checkResourceVersion()),this.appInfo&&this.checkAppVersion()},o.prototype.getLocalResourceMd5=function(){var n=t.Deferred(),r=function(){t.ajax({url:e.toUrl("$UI/resourceMd5.json"),async:!0,method:"get"}).done(function(e){e.curMd5&&n.resolve(e.curMd5),n.resolve("")}).fail(function(){n.resolve("")})};if(navigator.appUtils)navigator.appUtils.getLocalResourceMd5(function(e){e?n.resolve(e):r()},function(){r()});else{var s=i.get("justep_resource_md5");s?n.resolve(s):r()}return n.promise()},o.prototype.checkResourceMd5=function(){try{var e=window.__justep.versionInfo,t=e.resourceInfo.downloadURL,n=e.resourceInfo.mode,r=e.resourceInfo.curMd5,s=e.resourceInfo.preMd5,o=e.resourceInfo.indexPageURL;this.getLocalResourceMd5().done(function(u){var a=!0;if(u==r||u==""&&s=="")a=!1;if(navigator.appUtils){u==s&&(t=t.replace("www.zip","www_update.zip"));if(e.resourceInfo&&e.resourceInfo.indexURL)if(a){var f=n==="1";f||window.plugins.spinnerDialog.show("资源更新","正在进行资源更新,请稍后...",!0),navigator.appUtils.updateAppMd5Resource(t).done(function(){navigator.appUtils.setIndexPageUrl(o),navigator.appUtils.setLocalResourceMd5(r),window.plugins.spinnerDialog.hide(),f||(window.location.href=e.resourceInfo.indexPageURL)}).fail(function(){window.plugins.spinnerDialog.hide()})}else navigator.appUtils.setIndexPageUrl(o),navigator.appUtils.setLocalResourceMd5(r)}else i.set("justep_resource_md5",r),a?i.get("justep_resource_reload")==1?i.set("justep_resource_reload",!1):(i.set("justep_resource_reload",!0),location.reload(!0)):i.set("justep_resource_reload",!1)})}catch(u){}},o.prototype.checkResourceVersion=function(){try{if(navigator.appUtils){var e=window.__justep.versionInfo,t=e.resourceInfo.downloadURL,n=e.resourceInfo.mode,r=e.resourceInfo.isNewVersion,i=e.baseUrl+e.resourceInfo.version+e.resourceInfo.indexURL;e.resourceInfo&&e.resourceInfo.indexURL&&(n==="1"?r?navigator.appUtils.updateAppResource(t).done(function(){navigator.appUtils.setIndexPageUrl(i)}):navigator.appUtils.setIndexPageUrl(i):n==="2"?(navigator.appUtils.setIndexPageUrl(i),navigator.appUtils.updateAppResource(t)):n==="3"&&navigator.appUtils.setIndexPageUrl(i))}}catch(s){}},o.prototype.checkAppVersion=function(){var e=this;window.cordova&&cordova.getAppVersion&&cordova.getAppVersion.getVersionNumber(function(t){e.appInfo[e.env]&&e.versionCompare(t,e.appInfo[e.env].version)&&window.localStorage&&localStorage.getItem("versionIgnore")!==e.appInfo[e.env].version&&e.versionMsg.show({type:"YesNoCancel",title:"版本更新",message:e.appInfo[e.env].changeLog})})},o.prototype.versionCompare=function(e,t){if(e&&t){var n=e.split("."),r=t.split("."),i=Math.max(n.length,r.length);for(var s=0;s<i;s++){var o=~~r[s],u=~~n[s];if(o<u)return!1;if(o>u)return!0}}return!1},o.prototype.download=function(){window.open(this.appInfo[this.env].downloadURL,"_system")},o.prototype.ignore=function(){window.localStorage&&localStorage.setItem("versionIgnore",this.appInfo[this.env].version)},new o}),define("$model/UI2/system/components/justep/shell/shell.config",["require"],function(e){return{properties:{receiveMessageType:"string"},events:["onMessage","onBeforePageLoad","onPageViewLoad","onAfterPageLoad","onPageActive","onPageInactive","onBeforePageClose","onAfterPageClose"],binds:{}}}),define("$model/UI2/system/components/justep/shell/shell",["require","jquery","$UI/system/lib/justep","./shell.config","$UI/system/resources/system.res"],function(e){var t=e("jquery"),n=e("$UI/system/lib/justep"),r=e.normalizeName("./shell"),i=e("./shell.config");e("$UI/system/resources/system.res");var s="sys_message",o=["onBeforePageLoad","onPageViewLoad","onAfterPageLoad","onPageActive","onPageInactive","onBeforePageClose","onAfterPageClose"],u=n.ViewComponent.extend({buildTemplate:function(e){var t=new n.Message(n.Message.JUSTEP230073,r);throw n.Error.create(t)},constructor:function(e){this.callParent(e),this.receiveMessageType=undefined},dispose:function(){n.Shell.off(s,this._doRecvMsg,this),this._eventHandles&&t.each(this._eventHandles,function(e,t){n.Shell.off(e,t)}),this.callParent()},getConfig:function(){return i},init:function(e,t){this.callParent(e,t),this.bindEvent()},sendMessage:function(e,t){n.Shell.fireEvent(s,{data:e,type:t})},bindEvent:function(){var e=this;n.Shell.getImpl().then(function(){n.Shell.on(s,e._doRecvMsg,e),e._eventHandles={},t.each(o,function(t,r){e._eventHandles[r]=e._doEvent.bind(e,r),n.Shell.on(r,e._eventHandles[r])})})},_doRecvMsg:function(e){if(this.receiveMessageType===undefined||e.type===this.receiveMessageType){var t={source:this,message:e.data,type:e.type};this.fireEvent("onMessage",t)}},_doEvent:function(e,n){n=t.extend({},n),n.source=this,this.fireEvent(e,n)}}),a=function(e){var r=t.makeArray(arguments).slice(1);return n.Shell[e](r)};return t.each(n.Shell,function(e,r){t.isFunction(r)&&e!=="on"&&e!=="off"&&e!=="fireEvent"&&(u.prototype[e]=a.bind(n.Shell,e))}),n.Component.addOperations(u,{sendMessage:{label:n.Message.getMessage(n.Message.JUSTEP231132),argsDef:[{name:"msg",displayName:n.Message.getMessage(n.Message.JUSTEP231133),required:!0},{name:"type",displayName:n.Message.getMessage(n.Message.JUSTEP231143)}],method:function(e){return this.owner.sendMessage(e.msg,e.type)}},loadPage:{label:n.Message.getMessage(n.Message.JUSTEP231121),argsDef:[{name:"url",displayName:n.Message.getMessage(n.Message.JUSTEP231122),required:!0}],method:function(e){return n.Shell.loadPage(e.url)}},showPage:{label:n.Message.getMessage(n.Message.JUSTEP231123),argsDef:[{name:"url",displayName:n.Message.getMessage(n.Message.JUSTEP231124),required:!0},{name:"data",displayName:n.Message.getMessage(n.Message.JUSTEP231125)}],method:function(e){return n.Shell.showPage(e.url,e.data)}},showLeft:{label:n.Message.getMessage(n.Message.JUSTEP231126),method:function(e){return n.Shell.showLeft()}},showRight:{label:n.Message.getMessage(n.Message.JUSTEP231127),method:function(e){return n.Shell.showRight()}},closePage:{label:n.Message.getMessage(n.Message.JUSTEP231128),argsDef:[{name:"url",displayName:n.Message.getMessage(n.Message.JUSTEP231129)}],method:function(e){return n.Shell.closePage(e.url)}},showMainPage:{label:n.Message.getMessage(n.Message.JUSTEP231130),method:function(e){return n.Shell.showMainPage()}}}),n.Component.register(r,u),u}),define("$model/UI2/system/components/justep/shell/shellImpl.config",["require"],function(e){return{properties:{contentsXid:"string",wingXid:"string",pageMappings:"object"},events:[],binds:{}}}),define("$model/UI2/system/components/justep/shell/shellImpl",["require","$UI/system/lib/justep","$UI/system/lib/portal/shellImpl","./shellImpl.config","$UI/system/resources/system.res"],function(e){var t=e("$UI/system/lib/justep"),n=e("$UI/system/lib/portal/shellImpl"),r=e.normalizeName("./shellImpl"),i=e("./shellImpl.config");e("$UI/system/resources/system.res");var s=t.ViewComponent.extend({buildTemplate:function(e){var n=new t.Message(t.Message.JUSTEP230073,r);throw t.Error.create(n)},constructor:function(e){this.callParent(e),this.contentsXid="contents",this.wingXid="wing",window.addEventListener("message",function(e){if(e.data&&e.data.type=="hash"){var t=e.data.hash;t&&(window.location.hash=t)}})},getConfig:function(){return i},init:function(e,t){this.callParent(e,t),this.shellImpl=this.createShellImpl()},addPageMappings:function(e){this.shellImpl.addPageMappings(e)},loadPageMapping:function(){var e=this,t=e.__mapping_def__;if(!t){var n=e.$domNode;t={},n.find("mapping").each(function(){var e=$(this),n=e.attr("name"),r=e.attr("url");if(n&&r){t[n]={url:r};var i=e.attr("title");i&&(t[n].title=i)}}),e.__mapping_def__=t}return t},createShellImpl:function(){return this.loadPageMapping(),t.Shell.impl?(this.addPageMappings(this.__mapping_def__),t.Shell.impl):new n(this.getModel(),{contentsXid:this.contentsXid,wingXid:this.wingXid,pageMappings:this.__mapping_def__})},getShellImpl:function(){return this.shellImpl}});return t.Component.register(r,s),s});